// ==UserScript==
// @name         mam-plus
// @namespace    https://github.com/GardenShade
// @version      4.3.9
// @description  Tweaks and features for MAM
// @author       GardenShade
// @run-at       document-start
// @include      https://www.myanonamouse.net/*
// @include      https://*.myanonamouse.net/*
// @icon         https://i.imgur.com/dX44pSv.png
// @require      https://unpkg.com/axios/dist/axios.min.js
// @resource     MP_CSS https://raw.githubusercontent.com/gardenshade/mam-plus/master/release/main.css?v=4.3.9
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_listValues
// @grant        GM_deleteValue
// @grant        GM_addStyle
// @grant        GM_info
// @grant        GM_getResourceText
// ==/UserScript==
"use strict";var __awaiter=this&&this.__awaiter||function(t,e,s,o){return new(s||(s=Promise))((function(i,n){function r(t){try{l(o.next(t))}catch(t){n(t)}}function a(t){try{l(o.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,a)}l((o=o.apply(t,e||[])).next())}))},SettingGroup,MP;!function(t){t[t.Global=0]="Global",t[t.Home=1]="Home",t[t.Search=2]="Search",t[t.Requests=3]="Requests",t[t["Torrent Page"]=4]="Torrent Page",t[t.Shoutbox=5]="Shoutbox",t[t.Vault=6]="Vault",t[t["User Pages"]=7]="User Pages",t[t["Upload Page"]=8]="Upload Page",t[t.Forum=9]="Forum",t[t.Other=10]="Other"}(SettingGroup||(SettingGroup={}));class Util{static afTimer(){return new Promise(t=>{requestAnimationFrame(t)})}static setAttr(t,e){return new Promise(s=>{for(const s in e)t.setAttribute(s,e[s]);s()})}static objectLength(t){return Object.keys(t).length}static purgeSettings(){for(const t of GM_listValues())GM_deleteValue(t)}static reportCount(t,e,s){1!==e&&(s+="s"),MP.DEBUG&&console.log(`> ${t} ${e} ${s}`)}static startFeature(t,e,s){return __awaiter(this,void 0,void 0,(function*(){function o(){return __awaiter(this,void 0,void 0,(function*(){const s=new Promise(t=>setTimeout(t,2e3,!1)),o=Check.elemLoad(e);return Promise.race([s,o]).then(s=>!!s||(console.warn(`startFeature(${t.title}) Unable to initiate! Could not find element: ${e}`),!1))}))}if(MP.settingsGlob.push(t),GM_getValue(t.title)){if(s&&s.length>0){const t=[];return yield s.forEach(e=>{Check.page(e).then(e=>{t.push(e)})}),!0===t.includes(!0)&&o()}return o()}return!1}))}static trimString(t,e){return t.length>e&&(t=(t=t.substring(0,e+1)).substring(0,Math.min(t.length,t.lastIndexOf(" ")))),t}static bracketRemover(t){return t.replace(/{+.*?}+/g,"").replace(/\[\[|\]\]/g,"").replace(/<.*?>/g,"").replace(/\(.*?\)/g,"").trim()}static stringToArray(t,e){return void 0!==e&&"ws"!==e?t.split(e):t.match(/\S+/g)||[]}static csvToArray(t,e=","){const s=[];return t.split(e).forEach(t=>{s.push(t.trim())}),s}static arrayToString(t,e){let s="";return t.forEach((o,i)=>{s+=o,e&&i+1!==t.length&&(s+=" ")}),s}static nodeToElem(t){if(null!==t.firstChild)return t.firstChild.parentElement;{console.warn("Node-to-elem without childnode is untested");const e=t;t.appendChild(e);const s=t.firstChild.parentElement;return t.removeChild(e),s}}static caselessStringMatch(t,e){return 0===t.localeCompare(e,"en",{sensitivity:"base"})}static addTorDetailsRow(t,e,s){if(null===t||null===t.parentElement)throw new Error(`Add Tor Details Row: empty node or parent node @ ${t}`);return t.parentElement.insertAdjacentHTML("afterend",`<div class="torDetRow"><div class="torDetLeft">${e}</div><div class="torDetRight ${s}"><span class="flex"></span></div></div>`),document.querySelector(`.${s} .flex`)}static createLinkButton(t,e="none",s,o=0){const i=document.createElement("a");i.classList.add("mp_button_clone"),"none"!==e&&(i.setAttribute("href",e),i.setAttribute("target","_blank")),i.innerText=s,i.style.order=`${o}`,t.insertBefore(i,t.firstChild)}static createButton(t,e,s="h1",o,i="afterend",n="mp_btn"){return new Promise((r,a)=>{const l="string"==typeof o?document.querySelector(o):o,c=document.createElement(s);null===l?a(`${o} is null!`):(l.insertAdjacentElement(i,c),Util.setAttr(c,{id:`mp_${t}`,class:n,role:"button"}),c.innerHTML=e,r(c))})}static clipboardifyBtn(t,e,s=!0){t.style.cursor="pointer",t.addEventListener("click",()=>{const o=navigator;if(void 0===o)throw alert("Failed to copy text, likely due to missing browser support."),new Error("browser doesn't support 'navigator'?");s&&"string"==typeof e?(o.clipboard.writeText(e),console.log("[M+] Copied to your clipboard!")):(o.clipboard.readText().then(t=>{e(t)}),console.log("[M+] Copied from your clipboard!")),t.style.color="green"})}static getJSON(t){return new Promise((e,s)=>{const o=new XMLHttpRequest;o.open("GET",t,!0),o.setRequestHeader("Content-Type","application/json"),o.onreadystatechange=function(){4===o.readyState&&200===o.status&&e(o.responseText)},o.send()})}static getUserGiftHistory(t){return __awaiter(this,void 0,void 0,(function*(){const e=yield Util.getJSON(`https://www.myanonamouse.net/json/userBonusHistory.php?other_userid=${t}`);return JSON.parse(e)}))}static prettySiteTime(t,e,s){const o=new Date(1e3*t).toISOString();return e&&!s?o.split("T")[0]:!e&&s?o.split("T")[1]:o}static checkDashes(t,e){if(MP.DEBUG&&console.log(`checkDashes( ${t}, ${e} ): Count ${t.indexOf(" - ")}`),-1!==t.indexOf(" - ")){MP.DEBUG&&console.log("String contains a dash");const s=t.split(" - ");return s[0]===e?(MP.DEBUG&&console.log(`> String before dash is "${e}"; using string behind dash`),s[1]):s[0]}return t}}Util.bracketContents=t=>t.match(/\(([^)]+)\)/)[1],Util.randomNumber=(t,e)=>Math.floor(Math.random()*(e-t+1)+t),Util.sleep=t=>new Promise(e=>setTimeout(e,t)),Util.endOfHref=(t,e="/")=>t.href.split(e).pop(),Util.componentToHex=t=>{const e=t.toString(16);return 1===e.length?`0${e}`:e},Util.rgbToHex=(t,e,s)=>`#${Util.componentToHex(t)}${Util.componentToHex(e)}${Util.componentToHex(s)}`,Util.extractFloat=t=>{if(t.textContent)return(t.textContent.replace(/,/g,"").match(/\d+\.\d+/)||[]).map(t=>parseFloat(t));throw new Error("Target contains no text")},Util.goodreads={smartAuth:t=>{let e="";const s=Util.stringToArray(t);return s.forEach((t,o)=>{if(t.length<2){const i=s[o+1].length;e+=i<2?t:`${t} `}else e+=`${t} `}),e.trim()},buildSearchURL:(t,e)=>{MP.DEBUG&&console.log(`goodreads.buildGrSearchURL( ${t}, ${e} )`);let s=t;const o={book:()=>{s="title"},series:()=>{s="on",e+=", #"}};return o[t]&&o[t](),`https://r.mrd.ninja/https://www.goodreads.com/search?q=${encodeURIComponent(e.replace("%","")).replace("'","%27")}&search_type=books&search%5Bfield%5D=${s}`}},Util.getBookTitle=(t,e="")=>__awaiter(void 0,void 0,void 0,(function*(){if(null===t)throw new Error("getBookTitle() failed; element was null!");let s=t.innerText;return s=Util.trimString(Util.bracketRemover(s),50),s=Util.checkDashes(s,e),s})),Util.getBookAuthors=(t,e=3)=>__awaiter(void 0,void 0,void 0,(function*(){if(null===t)return console.warn("getBookAuthors() failed; element was null!"),[];{const s=[];return t.forEach(t=>{e>0&&(s.push(Util.goodreads.smartAuth(t.innerText)),e--)}),s}})),Util.getBookSeries=t=>__awaiter(void 0,void 0,void 0,(function*(){if(null===t)return console.warn("getBookSeries() failed; element was null!"),[];{const e=[];return t.forEach(t=>{e.push(t.innerText)}),e}})),Util.rowsToObj=(t,e=".torDetLeft",s=".torDetRight")=>{if(t.length<1)throw new Error(`Util.rowsToObj( ${t} ): Row list was empty!`);const o=[];return t.forEach(t=>{const i=t.querySelector(e),n=t.querySelector(s);i?o.push({key:i.textContent,value:n}):console.warn("Row title was empty!")}),o.reduce((t,e)=>(t[e.key]=e.value,t),{})},Util.formatBytes=(t,e=2)=>{if(0===t)return"0 Bytes";const s=0>e?0:e,o=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,o)).toFixed(s))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][o]};class Check{static elemLoad(t){return __awaiter(this,void 0,void 0,(function*(){MP.DEBUG&&console.log(`%c Looking for ${t}`,"background: #222; color: #555");let e=0;const s=t=>__awaiter(this,void 0,void 0,(function*(){const o=document.querySelector(t);if(void 0===o)throw`${t} is undefined!`;return null===o&&e<100?(yield Util.afTimer(),e++,yield s(t)):null===o&&e>=100?(e=0,!1):o||!1}));return s(t)}))}static elemObserver(t,e,s={childList:!0,attributes:!0}){return __awaiter(this,void 0,void 0,(function*(){let o=null;if("string"==typeof t&&(o=document.querySelector(t),null===o))throw new Error(`Couldn't find '${t}'`);MP.DEBUG&&console.log(`%c Setting observer on ${t}: ${o}`,"background: #222; color: #5d8aa8");const i=new MutationObserver(e);return i.observe(o,s),i}))}static updated(){return MP.DEBUG&&(console.group("Check.updated()"),console.log(`PREV VER = ${this.prevVer}`),console.log(`NEW VER = ${this.newVer}`)),new Promise(t=>{this.newVer!==this.prevVer?(MP.DEBUG&&console.log("Script is new or updated"),GM_setValue("mp_version",this.newVer),this.prevVer?(MP.DEBUG&&(console.log("Script has run before"),console.groupEnd()),t("updated")):(MP.DEBUG&&(console.log("Script has never run"),console.groupEnd()),GM_setValue("goodreadsBtn",!0),GM_setValue("alerts",!0),t("firstRun"))):(MP.DEBUG&&(console.log("Script not updated"),console.groupEnd()),t(!1))})}static page(t){const e=GM_getValue("mp_currentPage");let s=void 0;return new Promise(o=>{if(void 0!==e)o(t?t===e:e);else{let e=window.location.pathname;e=e.indexOf(".php")?e.split(".php")[0]:e;const i=e.split("/");i.shift(),MP.DEBUG&&console.log(`Page URL @ ${i.join(" -> ")}`);const n={"":()=>"home",index:()=>"home",shoutbox:()=>"shoutbox",preferences:()=>"settings",millionaires:()=>"vault",t:()=>"torrent",u:()=>"user",f:()=>{if("t"===i[1])return"forum thread"},tor:()=>"browse"===i[1]?"browse":"requests2"===i[1]?"request":"viewRequest"===i[1]?"request details":"upload"===i[1]?"upload":void 0};n[i[0]]?s=n[i[0]]():console.warn(`Page "${i}" is not a valid M+ page. Path: ${e}`),void 0!==s&&(GM_setValue("mp_currentPage",s),o(t?t===s:s))}MP.DEBUG&&console.groupEnd()})}static isBookCat(t){return t>=39&&t<=120}}Check.newVer=GM_info.script.version,Check.prevVer=GM_getValue("mp_version");class Style{constructor(){this._theme="light",this._prevTheme=this._getPrevTheme(),void 0!==this._prevTheme?this._theme=this._prevTheme:MP.DEBUG&&console.warn("no previous theme"),this._cssData=GM_getResourceText("MP_CSS")}get theme(){return this._theme}set theme(t){this._theme=t}alignToSiteTheme(){return __awaiter(this,void 0,void 0,(function*(){const t=yield this._getSiteCSS();this._theme=t.indexOf("dark")>0?"dark":"light",this._prevTheme!==this._theme&&this._setPrevTheme(),Check.elemLoad("body").then(()=>{const t=document.querySelector("body");t?t.classList.add(`mp_${this._theme}`):MP.DEBUG&&console.warn(`Body is ${t}`)})}))}injectLink(){const t="mp_css";if(document.getElementById(t))MP.DEBUG&&console.warn(`an element with the id "${t}" already exists`);else{const e=document.createElement("style");e.id=t,e.innerText=void 0!==this._cssData?this._cssData:"",document.querySelector("head").appendChild(e)}}_getPrevTheme(){return GM_getValue("style_theme")}_setPrevTheme(){GM_setValue("style_theme",this._theme)}_getSiteCSS(){return new Promise(t=>{const e=document.querySelector('head link[href*="ICGstation"]').getAttribute("href");"string"==typeof e?t(e):MP.DEBUG&&console.warn(`themeUrl is not a string: ${e}`)})}}class Alerts{constructor(){this._settings={scope:SettingGroup.Other,type:"checkbox",title:"alerts",desc:"Enable the MAM+ Alert panel for update information, etc."},MP.settingsGlob.push(this._settings)}notify(t,e){return MP.DEBUG&&console.group(`Alerts.notify( ${t} )`),new Promise(s=>{if(t)if(GM_getValue("alerts")){const o=(t,e)=>{if(MP.DEBUG&&console.log(`buildMsg( ${e} )`),t.length>0&&""!==t[0]){let s=`<h4>${e}:</h4><ul>`;return t.forEach(t=>{s+=`<li>${t}</li>`},s),s+="</ul>",s}return""},i=t=>{MP.DEBUG&&console.log(`buildPanel( ${t} )`),Check.elemLoad("body").then(()=>{document.body.innerHTML+=`<div class='mp_notification'>${t}<span>X</span></div>`;const e=document.querySelector(".mp_notification"),s=e.querySelector("span");try{s&&s.addEventListener("click",()=>{e&&e.remove()},!1)}catch(t){MP.DEBUG&&console.log(t)}})};let n="";"updated"===t?(MP.DEBUG&&console.log("Building update message"),n=`<strong>MAM+ has been updated!</strong> You are now using v${MP.VERSION}, created on ${MP.TIMESTAMP}. Discuss it on <a href='forums.php?action=viewtopic&topicid=41863'>the forums</a>.<hr>`,n+=o(e.UPDATE_LIST,"Changes"),n+=o(e.BUG_LIST,"Known Bugs")):"firstRun"===t?(n='<h4>Welcome to MAM+!</h4>Please head over to your <a href="/preferences/index.php">preferences</a> to enable the MAM+ settings.<br>Any bug reports, feature requests, etc. can be made on <a href="https://github.com/gardenshade/mam-plus/issues">Github</a>, <a href="/forums.php?action=viewtopic&topicid=41863">the forums</a>, or <a href="/sendmessage.php?receiver=108303">through private message</a>.',MP.DEBUG&&console.log("Building first run message")):MP.DEBUG&&console.warn(`Received msg kind: ${t}`),i(n),MP.DEBUG&&console.groupEnd(),s(!0)}else MP.DEBUG&&(console.log("Notifications are disabled."),console.groupEnd()),s(!1)})}get settings(){return this._settings}}class Debug{constructor(){this._settings={scope:SettingGroup.Other,type:"checkbox",title:"debug",desc:"Error log (<em>Click this checkbox to enable verbose logging to the console</em>)"},MP.settingsGlob.push(this._settings)}get settings(){return this._settings}}class HideHome{constructor(){this._settings={scope:SettingGroup.Global,type:"dropdown",title:"hideHome",tag:"Remove banner/home",options:{default:"Do not remove either",hideBanner:"Hide the banner",hideHome:"Hide the home button"},desc:"Remove the header image or Home button, because both link to the homepage"},this._tar="#mainmenu",Util.startFeature(this._settings,this._tar).then(t=>{t&&this._init()})}_init(){const t=GM_getValue(this._settings.title);"hideHome"===t?(document.body.classList.add("mp_hide_home"),console.log("[M+] Hid the home button!")):"hideBanner"===t&&(document.body.classList.add("mp_hide_banner"),console.log("[M+] Hid the banner!"))}get settings(){return this._settings}}class VaultLink{constructor(){this._settings={scope:SettingGroup.Global,type:"checkbox",title:"vaultLink",desc:"Make the Vault link bypass the Vault Info page"},this._tar="#millionInfo",Util.startFeature(this._settings,this._tar).then(t=>{t&&this._init()})}_init(){document.querySelector(this._tar).setAttribute("href","/millionaires/donate.php"),console.log("[M+] Made the vault text link to the donate page!")}get settings(){return this._settings}}class MiniVaultInfo{constructor(){this._settings={scope:SettingGroup.Global,type:"checkbox",title:"miniVaultInfo",desc:"Shorten the Vault link & ratio text"},this._tar="#millionInfo",Util.startFeature(this._settings,this._tar).then(t=>{t&&this._init()})}_init(){const t=document.querySelector(this._tar),e=document.querySelector("#tmR"),s=Number(Util.extractFloat(e)[0].toFixed(2)).toLocaleString();e.innerHTML=`${s} <img src="/pic/updownBig.png" alt="ratio">`;let o=parseInt(t.textContent.split(":")[1].split(" ")[1].replace(/,/g,""));o=Number((o/1e6).toFixed(3)),t.textContent=`Vault: ${o} million`,console.log("[M+] Shortened the vault & ratio numbers!")}get settings(){return this._settings}}class BonusPointDelta{constructor(){this._settings={scope:SettingGroup.Global,type:"checkbox",title:"bonusPointDelta",desc:"Display how many bonus points you've gained since last pageload"},this._tar="#tmBP",this._prevBP=0,this._currentBP=0,this._delta=0,this._displayBP=t=>{const e=document.querySelector(this._tar);let s="";s=t>0?`+${t}`:`${t}`,null!==e&&(e.innerHTML+=`<span class='mp_bpDelta'> (${s})</span>`)},this._setBP=t=>{GM_setValue(`${this._settings.title}Val`,`${t}`)},this._getBP=()=>{const t=GM_getValue(`${this._settings.title}Val`);return void 0===t?0:parseInt(t)},Util.startFeature(this._settings,this._tar).then(t=>{t&&this._init()})}_init(){const t=document.querySelector(this._tar);if(this._prevBP=this._getBP(),null!==t){const e=t.textContent.match(/\d+/g);this._currentBP=parseInt(e[0]),this._setBP(this._currentBP),this._delta=this._currentBP-this._prevBP,0===this._delta||isNaN(this._delta)||this._displayBP(this._delta)}}get settings(){return this._settings}}class BlurredHeader{constructor(){this._settings={scope:SettingGroup.Global,type:"checkbox",title:"blurredHeader",desc:"Add a blurred background to the header area"},this._tar="#siteMain > header",Util.startFeature(this._settings,this._tar).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=document.querySelector(`${this._tar}`),e=t.querySelector("img");if(e){const s=e.getAttribute("src"),o=document.createElement("div");t.classList.add("mp_blurredBack"),t.append(o),o.style.backgroundImage=s?`url(${s})`:"",o.classList.add("mp_container")}console.log("[M+] Added a blurred background to the header!")}))}get settings(){return this._settings}}class HideSeedbox{constructor(){this._settings={type:"checkbox",title:"hideSeedbox",scope:SettingGroup.Global,desc:'Remove the "Get A Seedbox" menu item'},this._tar="#menu",Util.startFeature(this._settings,this._tar,[]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=document.querySelector("#menu .sbDonCrypto");t&&(t.style.display="none"),console.log("[M+] Hid the Seedbox button!")}))}get settings(){return this._settings}}class FixedNav{constructor(){this._settings={type:"checkbox",title:"fixedNav",scope:SettingGroup.Global,desc:"Fix the navigation/search to the top of the page."},this._tar="body",Util.startFeature(this._settings,this._tar,[]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){document.querySelector("body").classList.add("mp_fixed_nav"),console.log("[M+] Pinned the nav/search to the top!")}))}get settings(){return this._settings}}class GiftNewest{constructor(){this._settings={scope:SettingGroup.Home,type:"checkbox",title:"giftNewest",desc:"Add buttons to Gift/Open all newest members"},this._tar="#fpNM",Util.startFeature(this._settings,this._tar,["home"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){this._trimGiftList();const t=document.querySelector(this._tar),e=Array.prototype.slice.call(t.getElementsByTagName("a")),s=e[e.length-1];e.forEach(t=>{t.setAttribute("class",`mp_refPoint_${Util.endOfHref(t)}`),GM_getValue("mp_lastNewGifted").indexOf(Util.endOfHref(t))>=0&&(t.innerText=`${t.innerText} ☑`,t.classList.add("mp_gifted"))});let o=GM_getValue("userGiftDefault_val");o?Number(o)>1e3||isNaN(Number(o))?o="1000":Number(o)<5&&(o="5"):o="100";const i=document.createElement("input");Util.setAttr(i,{type:"text",size:"3",id:"mp_giftAmounts",title:"Value between 5 and 1000",value:o}),s.insertAdjacentElement("afterend",i);const n=yield Util.createButton("giftAll","Gift All: ","button",`.mp_refPoint_${Util.endOfHref(s)}`,"afterend","mp_btn");n.style.marginRight="5px",n.style.marginTop="5px",n.addEventListener("click",()=>__awaiter(this,void 0,void 0,(function*(){let t=!0;for(const s of e)if(document.getElementById("mp_giftAllMsg").innerText="Sending Gifts... Please Wait",!s.classList.contains("mp_gifted")){const e=s.innerText,o=`https://www.myanonamouse.net/json/bonusBuy.php?spendtype=gift&amount=${document.getElementById("mp_giftAmounts").value}&giftTo=${e}`;t?t=!1:yield Util.sleep(3e3);const i=yield Util.getJSON(o);MP.DEBUG&&console.log("Gift Result",i),JSON.parse(i).success?(s.innerText=`${s.innerText} ☑`,s.classList.add("mp_gifted"),GM_setValue("mp_lastNewGifted",`${Util.endOfHref(s)},${GM_getValue("mp_lastNewGifted")}`)):JSON.parse(i).success||console.warn(JSON.parse(i).error)}n.disabled=!0,document.getElementById("mp_giftAllMsg").innerText="Gifts completed to all Checked Users"})),!1),e[e.length-1].after(document.createElement("br")),document.getElementById("mp_giftAmounts").addEventListener("input",()=>{const t=document.getElementById("mp_giftAmounts").value,e=document.getElementById("mp_giftAll");Number(t)>1e3||Number(t)<5||isNaN(Number(t))?(e.disabled=!0,e.setAttribute("title","Disabled")):(e.disabled=!1,e.setAttribute("title",`Gift All ${t}`))});const r=yield Util.createButton("openTabs","Open Ungifted In Tabs","button","[id=mp_giftAmounts]","afterend","mp_btn");r.setAttribute("title","Open new tab for each"),r.addEventListener("click",()=>{for(const t of e)t.classList.contains("mp_gifted")||window.open(t.href,"_blank")},!1);let a=document.getElementById("tmBP").innerText;a.indexOf("(")>=0&&(a=a.substring(0,a.indexOf("(")));const l=document.createElement("span");l.setAttribute("id","mp_giftAllMsg"),l.innerText="Available "+a,document.getElementById("mp_giftAmounts").after(l),document.getElementById("mp_giftAllMsg").after(document.createElement("br")),document.getElementById("mp_giftAllMsg").insertAdjacentHTML("beforebegin","<br>"),console.log("[M+] Adding gift new members button to Home page...")}))}_trimGiftList(){if(GM_getValue("mp_lastNewGifted")){const t=GM_getValue("mp_lastNewGifted").split(",");let e="";if(t.length>50)for(const s of t){if(!(t.indexOf(s)<=49))break;e=e+s+",",GM_setValue("mp_lastNewGifted",e)}}else GM_setValue("mp_lastNewGifted","")}get settings(){return this._settings}}class HideNews{constructor(){this._settings={scope:SettingGroup.Home,title:"hideNews",type:"checkbox",desc:"Tidy the homepage and allow News to be hidden"},this._tar=".mainPageNewsHead",this._valueTitle=`${this._settings.title}_val`,this._icon="❎",this._checkForSeen=()=>__awaiter(this,void 0,void 0,(function*(){const t=GM_getValue(this._valueTitle),e=this._getNewsItems();if(MP.DEBUG&&console.log(this._valueTitle,":\n",t),t&&e){t.split(this._icon).forEach(t=>{e.forEach(e=>{e.textContent===t&&e.remove()})}),document.querySelector(".mainPageNewsSub")||this._adjustHeaderSize(this._tar,!1)}})),this._removeClock=()=>{const t=document.querySelector("#mainBody .fpTime");t&&t.remove()},this._adjustHeaderSize=(t,e)=>{const s=document.querySelector(t);s&&(!1===e?s.style.display="none":s.style.fontSize="2em")},this._addHiderButton=()=>{const t=this._getNewsItems();t&&t.forEach(t=>{const e=document.createElement("div");e.textContent=this._icon,Util.setAttr(e,{style:"display:inline-block;margin-right:0.7em;cursor:pointer;",class:"mp_clearBtn"}),e.addEventListener("click",()=>{const e=GM_getValue(this._valueTitle)?GM_getValue(this._valueTitle):"";MP.DEBUG&&console.log(`Hiding... ${e}${t.textContent}`),GM_setValue(this._valueTitle,`${e}${t.textContent}`),t.remove();const s=this._getNewsItems();s&&s.length<1&&this._adjustHeaderSize(this._tar,!1)}),t.firstChild&&t.firstChild.before(e)})},this._cleanValues=(t=3)=>{let e=GM_getValue(this._valueTitle);MP.DEBUG&&console.log(`GM_getValue(${this._valueTitle})`,e),e&&(e=Util.arrayToString(e.split(this._icon).slice(0-t)),GM_setValue(this._valueTitle,e))},this._getNewsItems=()=>document.querySelectorAll('div[class^="mainPageNews"]'),Util.startFeature(this._settings,this._tar,["home"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){this._removeClock(),this._adjustHeaderSize(this._tar),yield this._checkForSeen(),this._addHiderButton(),console.log("[M+] Cleaned up the home page!")}))}get settings(){return this._settings}}class Shared{constructor(){this.fillGiftBox=(t,e)=>(MP.DEBUG&&console.log(`Shared.fillGiftBox( ${t}, ${e} )`),new Promise(s=>{Check.elemLoad(t).then(()=>{const o=document.querySelector(t);if(o){const t=parseInt(GM_getValue(`${e}_val`));let i=parseInt(o.getAttribute("max"));!isNaN(t)&&t<=i&&(i=t),o.value=i.toFixed(0),s(i)}else s(void 0)})})),this.getSearchList=()=>(MP.DEBUG&&console.log("Shared.getSearchList( )"),new Promise((t,e)=>{Check.elemLoad('#ssr tr[id ^= "tdr"] td').then(()=>{const s=document.querySelectorAll('#ssr tr[id ^= "tdr"]');null==s?e(`snatchList is ${s}`):t(s)})})),this.goodreadsButtons=(t,e,s,o)=>__awaiter(this,void 0,void 0,(function*(){let i,n;console.log("[M+] Adding the MAM-to-Goodreads buttons...");let r="";Util.addTorDetailsRow(o,"Search Goodreads","mp_grRow"),yield Promise.all([i=Util.getBookSeries(s),n=Util.getBookAuthors(e)]),yield Check.elemLoad(".mp_grRow .flex");const a=document.querySelector(".mp_grRow .flex");if(null===a)throw new Error("Button row cannot be targeted!");i.then(t=>{t.length>0?t.forEach(e=>{const s=t.length>1?`Series: ${e}`:"Series",o=Util.goodreads.buildSearchURL("series",e);Util.createLinkButton(a,o,s,4)}):console.warn("No series data detected!")}),n.then(t=>{if(t.length>0){r=t.join(" ");const e=Util.goodreads.buildSearchURL("author",r);Util.createLinkButton(a,e,"Author",3)}else console.warn("No author data detected!")}).then(()=>__awaiter(this,void 0,void 0,(function*(){const e=yield Util.getBookTitle(t,r);if(""!==e){const t=Util.goodreads.buildSearchURL("book",e);if(Util.createLinkButton(a,t,"Title",2),""!==r){const t=Util.goodreads.buildSearchURL("on",`${e} ${r}`);Util.createLinkButton(a,t,"Title + Author",1)}else MP.DEBUG&&console.log(`Failed to generate Title+Author link!\nTitle: ${e}\nAuthors: ${r}`)}else console.warn("No title data detected!")}))),console.log("[M+] Added the MAM-to-Goodreads buttons!")}))}}class TorGiftDefault{constructor(){this._settings={scope:SettingGroup["Torrent Page"],type:"textbox",title:"torGiftDefault",tag:"Default Gift",placeholder:"ex. 5000, max",desc:"Autofills the Gift box with a specified number of points. (<em>Or the max allowable value, whichever is lower</em>)"},this._tar="#thanksArea input[name=points]",Util.startFeature(this._settings,this._tar,["torrent"]).then(t=>{t&&this._init()})}_init(){(new Shared).fillGiftBox(this._tar,this._settings.title).then(t=>console.log(`[M+] Set the default gift amount to ${t}`))}get settings(){return this._settings}}class GoodreadsButton{constructor(){this._settings={scope:SettingGroup["Torrent Page"],type:"checkbox",title:"goodreadsButton",desc:"Enable the MAM-to-Goodreads buttons"},this._tar="#submitInfo",this._share=new Shared,Util.startFeature(this._settings,this._tar,["torrent"]).then(t=>{if(t){const t=document.querySelector("#fInfo [class^=cat]");t&&Check.isBookCat(parseInt(t.className.substr(3)))?this._init():console.log("[M+] Not a book category; skipping Goodreads buttons")}})}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=document.querySelectorAll("#torDetMainCon .torAuthors a"),e=document.querySelector("#torDetMainCon .TorrentTitle"),s=document.querySelectorAll("#Series a"),o=document.querySelector(this._tar);this._share.goodreadsButtons(e,t,s,o)}))}get settings(){return this._settings}}class CurrentlyReading{constructor(){this._settings={type:"checkbox",scope:SettingGroup["Torrent Page"],title:"currentlyReading",desc:'Add a button to generate a "Currently Reading" forum snippet'},this._tar="#torDetMainCon .TorrentTitle",Util.startFeature(this._settings,this._tar,["torrent"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){console.log("[M+] Adding Currently Reading section...");const t=document.querySelector("#torDetMainCon .TorrentTitle").textContent,e=document.querySelectorAll("#torDetMainCon .torAuthors a"),s=window.location.pathname.split("/")[2],o=document.querySelector("#fInfo");if(null===t)throw new Error("Title field was null");const i=yield Util.addTorDetailsRow(o,"Currently Reading","mp_crRow"),n=yield this._generateSnippet(s,t,e),r=yield this._buildButton(i,n);Util.clipboardifyBtn(r,n)}))}_generateSnippet(t,e,s){let o=[];return s.forEach(t=>o.push((t=>`[url=${t.href.replace("https://www.myanonamouse.net","")}]${t.textContent}[/url]`)(t))),o.length>3&&(o=[...o.slice(0,3),"etc."]),`[url=/t/${t}]${e}[/url] by [i]${o.join(", ")}[/i]`}_buildButton(t,e){return t.innerHTML=`<textarea rows="1" cols="80" style='margin-right:5px'>${e}</textarea>`,Util.createLinkButton(t,"none","Copy",2),document.querySelector(".mp_crRow .mp_button_clone").classList.add("mp_reading"),document.querySelector(".mp_reading")}get settings(){return this._settings}}class RatioProtect{constructor(){this._settings={type:"checkbox",scope:SettingGroup["Torrent Page"],title:"ratioProtect",desc:"Protect your ratio with warnings &amp; ratio calculations"},this._tar="#ratio",this._rcRow="mp_ratioCostRow",Util.startFeature(this._settings,this._tar,["torrent"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){console.log("[M+] Enabling ratio protection...");const t=document.querySelector("#tddl"),e=document.querySelector("#download .torDetInnerTop"),s=document.querySelector(this._tar),o=document.querySelector("#tmR"),i=document.querySelector("#DLhistory"),[n,r,a]=this._checkCustomSettings();if(MP.DEBUG&&console.log(`Ratio protection levels set to: ${n}, ${r}, ${a}`),s&&o){const l=Util.extractFloat(o)[0]-Util.extractFloat(s)[0];if(MP.DEBUG&&console.log(`Current ${Util.extractFloat(o)[0]} | New ${Util.extractFloat(s)[0]} | Dif ${l}`),!isNaN(l)&&l>.009){!i&&e&&(e.innerHTML=`Ratio loss ${l.toFixed(2)}`,e.style.fontWeight="normal"),document.querySelector(".torDetBottom").insertAdjacentHTML("beforebegin",`<div class="torDetRow" id="Mrp_row"><div class="torDetLeft">Cost to Restore Ratio</div><div class="torDetRight ${this._rcRow}"><span id="mp_foobar"></span></div></div>`);const c=document.querySelector("#size span");if(c){const t=c.textContent.split(/\s+/),e=["Bytes","KB","MB","GB","TB"],s=Number(t[0])*Math.pow(1024,e.indexOf(t[1]))*Util.extractFloat(o)[0],i=Math.floor(125*s/268435456).toLocaleString();document.querySelector(`.${this._rcRow}`).innerHTML=`<b>${Util.formatBytes(s)}</b>&nbsp;upload (${i} BP).&nbsp;<abbr title='Contributing 2,000 BP to each vault cycle gives you almost one FL wedge per day on average.'>[info]</abbr>`}t&&e&&(l>n&&(t.style.backgroundColor="SpringGreen",t.style.color="black"),l>a||Util.extractFloat(s)[0]<GM_getValue("ratioProtectMin_val")?(t.style.backgroundColor="Red",t.style.cursor="no-drop",t.innerHTML="FL Recommended",e.style.fontWeight="bold"):l>r&&(t.style.backgroundColor="Orange"))}}}))}_checkCustomSettings(){let t=parseFloat(GM_getValue("ratioProtectL1_val")),e=parseFloat(GM_getValue("ratioProtectL2_val")),s=parseFloat(GM_getValue("ratioProtectL3_val"));return isNaN(s)&&(s=1),isNaN(e)&&(e=2/3),isNaN(t)&&(t=1/3),e>s&&(e=s),t>e&&(t=e),isNaN(e)&&(e=s<2/3?s:2/3),isNaN(t)&&(t=e<1/3?e:1/3),[t,e,s]}get settings(){return this._settings}}class RatioProtectL1{constructor(){this._settings={scope:SettingGroup["Torrent Page"],type:"textbox",title:"ratioProtectL1",tag:"Ratio Warn L1",placeholder:"default: 0.3",desc:"Set the smallest threshhold to warn of ratio changes. (<em>This is a slight color change</em>)."},this._tar="#download",Util.startFeature(this._settings,this._tar,["torrent"]).then(t=>{t&&this._init()})}_init(){console.log("[M+] Set custom L1 Ratio Protection!")}get settings(){return this._settings}}class RatioProtectL2{constructor(){this._settings={scope:SettingGroup["Torrent Page"],type:"textbox",title:"ratioProtectL2",tag:"Ratio Warn L2",placeholder:"default: 0.6",desc:"Set the median threshhold to warn of ratio changes. (<em>This is a noticeable color change</em>)."},this._tar="#download",Util.startFeature(this._settings,this._tar,["torrent"]).then(t=>{t&&this._init()})}_init(){console.log("[M+] Set custom L2 Ratio Protection!")}get settings(){return this._settings}}class RatioProtectL3{constructor(){this._settings={scope:SettingGroup["Torrent Page"],type:"textbox",title:"ratioProtectL3",tag:"Ratio Warn L3",placeholder:"default: 1",desc:"Set the highest threshhold to warn of ratio changes. (<em>This disables download without FL use</em>)."},this._tar="#download",Util.startFeature(this._settings,this._tar,["torrent"]).then(t=>{t&&this._init()})}_init(){console.log("[M+] Set custom L2 Ratio Protection!")}get settings(){return this._settings}}class RatioProtectMin{constructor(){this._settings={type:"textbox",title:"ratioProtectMin",scope:SettingGroup["Torrent Page"],tag:"Minimum Ratio",placeholder:"ex. 100",desc:"Trigger the maximum warning if your ratio would drop below this number."},this._tar="#download",Util.startFeature(this._settings,this._tar,["torrent"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){console.log("[M+] Added custom minimum ratio!")}))}get settings(){return this._settings}}class ForumFLGift{constructor(){this._settings={type:"checkbox",scope:SettingGroup.Forum,title:"forumFLGift",desc:"Add a Thank button to forum posts. (<em>Sends a FL wedge</em>)"},this._tar=".forumLink",Util.startFeature(this._settings,this._tar,["forum thread"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){console.log("[M+] Enabling Forum Gift Button...");const t=document.querySelector("#mainBody");Array.prototype.slice.call(t.getElementsByClassName("coltable")).forEach(t=>{let e=t.childNodes[1];e=e.childNodes[4],e=e.childNodes[3];let s=t.previousSibling.getAttribute("name");"last"===s&&(s=t.previousSibling.previousSibling.getAttribute("name"));const o=document.createElement("a");o.setAttribute("class","cursor"),o.setAttribute("id","mp_"+s+"_text");const i=document.createElement("img");i.setAttribute("src","https://cdn.myanonamouse.net/imagebucket/108303/thank.gif"),o.appendChild(i),e.appendChild(o),o.addEventListener("click",()=>__awaiter(this,void 0,void 0,(function*(){if(o.childNodes.length<=1){const t=o.parentElement.parentElement.parentElement,e=t.querySelector('a[href^="/u/"]'),s=t.querySelector('a[href^="/f/t/"]').getAttribute("href");let i=document.getElementById("userMenu").innerText;i=i.substring(0,i.indexOf(" "));let n=document.title;n=n.substring(22,n.indexOf("|")-1);let r=`https://www.myanonamouse.net/json/bonusBuy.php?spendtype=sendWedge&giftTo=${e.innerText}&message=${i} wants to thank you for your contribution to the forum topic [url=https://myanonamouse.net${s}]${n}[/url]`;r=r.replace("#","%23");const a=yield Util.getJSON(r);MP.DEBUG&&console.log("Gift Result",a),JSON.parse(a).success?o.appendChild(document.createTextNode("FL Gift Successful!")):"You can only send a user one wedge per day."===JSON.parse(a).error?o.appendChild(document.createTextNode("Failed: Already Gifted This User Today!")):"Invalid user, this user is not currently accepting wedges"===JSON.parse(a).error?o.appendChild(document.createTextNode("Failed: This User Does Not Accept Gifts!")):o.appendChild(document.createTextNode("FL Gift Failed!"))}})),!1)})}))}get settings(){return this._settings}}class ProcessShouts{static watchShoutbox(t,e,s){Check.elemObserver(t,t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{const o=Util.nodeToElem(t);if(!/^mp_/.test(o.getAttribute("id"))&&!o.classList.contains("dateBreak")&&void 0!==e&&e.length>0){if(void 0===s)throw new Error("Usertype must be defined if filtering names!");const o=this.extractFromShout(t,'a[href^="/u/"]',"href"),i=this.extractFromShout(t,"a > span","text");e.forEach(e=>{(`/u/${e}`===o||Util.caselessStringMatch(e,i))&&this.styleShout(t,s)})}})})},{childList:!0})}static watchShoutboxReply(t,e){MP.DEBUG&&console.log("watchShoutboxReply(",t,e,")");const s=(t,e,s)=>`@[ulink=${s=s.match(/\d+/g).join("")}${e=e?`;${e}`:""}]${t}[/ulink]`,o=document.getElementById("shbox_text");Check.elemObserver(t,t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{const i=Util.nodeToElem(t);if(/^mp_/.test(i.getAttribute("id"))||i.classList.contains("dateBreak"))return;const n=(t=>{if(t){const e=(t=>t.style.backgroundColor?t.style.backgroundColor:t.style.color?t.style.color:null)(t);if(e){const t=Util.bracketContents(e).split(",");return Util.rgbToHex(parseInt(t[0]),parseInt(t[1]),parseInt(t[2]))}return null}throw new Error(`Element is null!\n${t}`)})(Util.nodeToElem(t).querySelector('a[href^="/u/"] span')),r=this.extractFromShout(t,"a > span","text"),a=this.extractFromShout(t,'a[href^="/u/"]',"href"),l=document.createElement("span");1===e?(l.innerHTML="<button>⤺</button>",l.querySelector("button").addEventListener("click",()=>{""===o.value?o.value=`${s(r,n,a)}: `:o.value=`${o.value} ${s(r,n,a)} `,o.focus()})):2===e&&(l.innerHTML="<button>⤽</button>",l.querySelector("button").addEventListener("click",()=>{const e=this.quoteShout(t,65);""!==e?(o.value=`${s(r,n,a)}: “[i]${e}[/i]” `,o.focus()):(o.value=`${s(r,n,a)}: `,o.focus())})),l.setAttribute("class","mp_replyButton"),t.insertBefore(l,t.childNodes[2])})})},{childList:!0})}static quoteShout(t,e){const s=[],o=t.firstChild.parentElement.querySelectorAll(".mp_replyButton").length;t.childNodes.forEach(t=>{if(t.childNodes.length>0){const e=Util.nodeToElem(t);e.hasAttribute("href")&&e.getAttribute("href").indexOf("/u/")<0?s.push("[Link]"):s.push(t.textContent)}else s.push(t.textContent)});let i=s.slice(3+o).join("");0===i.indexOf(":")&&(i=i.substr(2)),i=i.replace(/\u{201c}(.*?)\u{201d}/gu,"");let n=Util.trimString(i.trim(),e);return n!==i.trim()&&(n+=" […]"),n}static extractFromShout(t,e,s){const o=Util.nodeToElem(t).classList.contains("dateBreak");if(null===t||o)throw new Error("Could not extract shout! Node was null");{const o=Util.nodeToElem(t).querySelector(e);if(null!==o){let t;if(t="text"!==s?o.getAttribute(s):o.textContent,null!==t)return t;throw new Error("Could not extract shout! Attribute was null")}throw new Error("Could not extract shout! Element was null")}}static styleShout(t,e){const s=Util.nodeToElem(t);if("priority"===e){const t=GM_getValue("priorityStyle_val");s.style.background=t?`hsla(${t})`:"hsla(0,0%,50%,0.3)"}else"mute"===e&&s.classList.add("mp_muted")}}class PriorityUsers{constructor(){this._settings={scope:SettingGroup.Shoutbox,type:"textbox",title:"priorityUsers",tag:"Emphasize Users",placeholder:"ex. system, 25420, 77618",desc:"Emphasizes messages from the listed users in the shoutbox. (<em>This accepts user IDs and usernames. It is not case sensitive.</em>)"},this._tar=".sbf div",this._priorityUsers=[],this._userType="priority",Util.startFeature(this._settings,this._tar,["shoutbox","home"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=GM_getValue(`${this.settings.title}_val`);if(void 0===t)throw new Error("Userlist is not defined!");this._priorityUsers=yield Util.csvToArray(t),ProcessShouts.watchShoutbox(this._tar,this._priorityUsers,this._userType),console.log("[M+] Highlighting users in the shoutbox...")}))}get settings(){return this._settings}}class PriorityStyle{constructor(){this._settings={scope:SettingGroup.Shoutbox,type:"textbox",title:"priorityStyle",tag:"Emphasis Style",placeholder:"default: 0, 0%, 50%, 0.3",desc:"Change the color/opacity of the highlighting rule for emphasized users' posts. (<em>This is formatted as Hue (0-360), Saturation (0-100%), Lightness (0-100%), Opacity (0-1)</em>)"},this._tar=".sbf div",Util.startFeature(this._settings,this._tar,["shoutbox","home"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){console.log("[M+] Setting custom highlight for priority users...")}))}get settings(){return this._settings}}class MutedUsers{constructor(){this._settings={scope:SettingGroup.Shoutbox,type:"textbox",title:"mutedUsers",tag:"Mute users",placeholder:"ex. 1234, gardenshade",desc:"Obscures messages from the listed users in the shoutbox until hovered. (<em>This accepts user IDs and usernames. It is not case sensitive.</em>)"},this._tar=".sbf div",this._mutedUsers=[],this._userType="mute",Util.startFeature(this._settings,this._tar,["shoutbox","home"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=GM_getValue(`${this.settings.title}_val`);if(void 0===t)throw new Error("Userlist is not defined!");this._mutedUsers=yield Util.csvToArray(t),ProcessShouts.watchShoutbox(this._tar,this._mutedUsers,this._userType),console.log("[M+] Obscuring muted users...")}))}get settings(){return this._settings}}class GiftButton{constructor(){this._settings={scope:SettingGroup.Shoutbox,type:"checkbox",title:"giftButton",desc:"Places a Gift button in Shoutbox dot-menu"},this._tar=".sbf",Util.startFeature(this._settings,this._tar,["shoutbox","home"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){console.log("[M+] Initialized Gift Button.");const t=document.getElementById("sbf"),e=t.firstChild;t.addEventListener("click",s=>__awaiter(this,void 0,void 0,(function*(){const o=s.target,i=o.closest(".sb_menu");let n=o.closest("div").innerText;if(n='Sent on Shoutbox message: "'+n.substring(n.indexOf(": ")+2)+'" at '+n.substring(0,8),!o.closest(".sb_menu")||"1"===i.getAttribute("data-ee"))return;console.log("[M+] Adding Gift Button...");const r=document.getElementById("sbMenuMain");do{yield Util.sleep(5)}while(!r.hasChildNodes());const a=Util.nodeToElem(r.childNodes[0]).getAttribute("data-uid");let l=GM_getValue("userGiftDefault_val");l?Number(l)>1e3||isNaN(Number(l))?l="1000":Number(l)<5&&(l="5"):l="100";const c=document.createElement("span");c.setAttribute("id","giftButton"),c.innerHTML=`<button>Gift: </button><span>&nbsp;</span><input type="text" size="3" id="mp_giftValue" title="Value between 5 and 1000" value="${l}">`,r.childNodes[0].appendChild(c),c.querySelector("button").addEventListener("click",()=>{const s=document.getElementById("mp_giftValue").value,o=new XMLHttpRequest,i=`https://www.myanonamouse.net/json/bonusBuy.php?spendtype=gift&amount=${s}&giftTo=${a}&message=${encodeURIComponent(n)}`;o.open("GET",i,!0),o.setRequestHeader("Content-Type","application/json"),o.onreadystatechange=function(){if(4===o.readyState&&200===o.status){const i=JSON.parse(o.responseText),n=document.createElement("div");if(n.setAttribute("id","mp_giftStatusElem"),e.appendChild(n),i.success){const t=document.createTextNode("Points Gift Successful: Value: "+s);n.appendChild(t),n.classList.add("mp_success")}else{const t=document.createTextNode("Points Gift Failed: Error: "+i.error);n.appendChild(t),n.classList.add("mp_fail")}t.scrollTop=t.scrollHeight}t.scrollTop=t.scrollHeight},o.send(),t.getElementsByClassName("sb_clicked_row")[0].removeAttribute("class"),document.getElementById("sbMenuMain").setAttribute("class","sbBottom hideMe")}),c.querySelector("input").addEventListener("input",()=>{const t=document.getElementById("mp_giftValue").value;Number(t)>1e3||Number(t)<5||isNaN(Number(t))?c.querySelector("button").disabled=!0:c.querySelector("button").disabled=!1}),console.log("[M+] Gift Button added!")})))}))}get settings(){return this._settings}}class ReplySimple{constructor(){this._settings={scope:SettingGroup.Shoutbox,type:"checkbox",title:"replySimple",desc:"Places a Reply button in Shoutbox: &#10554;"},this._tar=".sbf div",this._replySimple=1,Util.startFeature(this._settings,this._tar,["shoutbox","home"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){ProcessShouts.watchShoutboxReply(this._tar,this._replySimple),console.log("[M+] Adding Reply Button...")}))}get settings(){return this._settings}}class ReplyQuote{constructor(){this._settings={scope:SettingGroup.Shoutbox,type:"checkbox",title:"replyQuote",desc:"Places a Reply with Quote button in Shoutbox: &#10557;"},this._tar=".sbf div",this._replyQuote=2,Util.startFeature(this._settings,this._tar,["shoutbox","home"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){ProcessShouts.watchShoutboxReply(this._tar,this._replyQuote),console.log("[M+] Adding Reply with Quote Button...")}))}get settings(){return this._settings}}class QuickShout{constructor(){this._settings={scope:SettingGroup.Shoutbox,type:"checkbox",title:"quickShout",desc:"Create feature below shoutbox to store pre-set messages."},this._tar=".sbf div",Util.startFeature(this._settings,this._tar,["shoutbox","home"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){console.log("[M+] Adding Quick Shout Buttons...");const replyBox=document.getElementById("shbox_text");let jsonList=JSON.parse("{ \"Intro\":\"Welcome to QuickShout MAM+er! Here you can create preset Shout messages for quick responses and knowledge sharing. 'Clear' clears the entry to start selection process over. 'Select' takes whatever QuickShout is in the TextArea and puts in your Shout response area. 'Save' will store the Selection Name and Text Area Combo for future use as a QuickShout, and has color indicators. Green = saved as-is. Yellow = QuickShout Name exists and is saved, but content does not match what is stored. Orange = no entry matching that name, not saved. 'Delete' will permanently remove that entry from your stored QuickShouts (button only shows when exists in storage). For new entries have your QuickShout Name typed in BEFORE you craft your text or risk it being overwritten by something that exists as you type it. Thanks for using MAM+!\" }");const shoutBox=document.getElementById("fpShout"),shoutFoot=shoutBox.querySelector(".blockFoot");shoutFoot.setAttribute("id","mp_blockFoot"),shoutFoot.style.height="2.5em";const comboBoxDiv=document.createElement("div");comboBoxDiv.style.float="left",comboBoxDiv.style.marginLeft="1em",comboBoxDiv.style.marginBottom=".5em",comboBoxDiv.style.marginTop=".5em";const comboBoxLabel=document.createElement("label");comboBoxLabel.setAttribute("for","quickShoutData"),comboBoxLabel.innerText="Choose a QuickShout",comboBoxLabel.setAttribute("id","mp_comboBoxLabel");const comboBoxInput=document.createElement("input");comboBoxInput.style.marginLeft=".5em",comboBoxInput.setAttribute("list","mp_comboBoxList"),comboBoxInput.setAttribute("id","mp_comboBoxInput");const comboBoxList=document.createElement("datalist");comboBoxList.setAttribute("id","mp_comboBoxList"),GM_getValue("mp_quickShout")?(jsonList=JSON.parse(GM_getValue("mp_quickShout")),Object.keys(jsonList).forEach(t=>{const e=document.createElement("option");e.value=t.replace(/ಠ/g," "),comboBoxList.appendChild(e)})):(GM_setValue("mp_quickShout",JSON.stringify(jsonList)),Object.keys(jsonList).forEach(t=>{const e=document.createElement("option");e.value=t.replace(/ಠ/g," "),comboBoxList.appendChild(e)})),comboBoxDiv.appendChild(comboBoxLabel),comboBoxDiv.appendChild(comboBoxInput),comboBoxDiv.appendChild(comboBoxList);const clearButton=document.createElement("button");clearButton.style.marginLeft="1em",clearButton.innerHTML="Clear";const deleteButton=document.createElement("button");deleteButton.style.marginLeft="6em",deleteButton.style.display="none",deleteButton.style.backgroundColor="Red",deleteButton.innerHTML="DELETE";const selectButton=document.createElement("button");selectButton.style.marginLeft="1em",selectButton.innerHTML="↑ Select";const saveButton=document.createElement("button");saveButton.style.marginLeft="1em",saveButton.innerHTML="Save",comboBoxDiv.appendChild(clearButton),comboBoxDiv.appendChild(selectButton),comboBoxDiv.appendChild(saveButton),comboBoxDiv.appendChild(deleteButton);const quickShoutText=document.createElement("textarea");quickShoutText.style.height="50%",quickShoutText.style.margin="1em",quickShoutText.style.width="97%",quickShoutText.id="mp_quickShoutText",quickShoutText.style.display="none",selectButton.addEventListener("click",()=>__awaiter(this,void 0,void 0,(function*(){quickShoutText.value&&(replyBox.value=quickShoutText.value,replyBox.focus())})),!1),deleteButton.addEventListener("click",()=>__awaiter(this,void 0,void 0,(function*(){Object.keys(jsonList).length>1?(delete jsonList[comboBoxInput.value.replace(/ /g,"ಠ")],GM_setValue("mp_quickShout",JSON.stringify(jsonList)),saveButton.style.backgroundColor="Green",saveButton.style.color="",deleteButton.style.display="none",comboBoxList.innerHTML="",Object.keys(jsonList).forEach(t=>{const e=document.createElement("option");e.value=t.replace(/ಠ/g," "),comboBoxList.appendChild(e)})):(delete jsonList[comboBoxInput.value.replace(/ಠ/g,"ಠ")],GM_deleteValue("mp_quickShout"),saveButton.style.backgroundColor="Green",saveButton.style.color="",deleteButton.style.display="none");const t=new Event("input");comboBoxInput.dispatchEvent(t)})),!1),saveButton.addEventListener("click",()=>__awaiter(this,void 0,void 0,(function*(){if(quickShoutText.value&&comboBoxInput.value){const replacedText=comboBoxInput.value.replace(/ /g,"ಠ");eval("jsonList."+replacedText+'= "'+encodeURIComponent(quickShoutText.value)+'";'),GM_setValue("mp_quickShout",JSON.stringify(jsonList)),saveButton.style.backgroundColor="Green",saveButton.style.color="",deleteButton.style.display="",comboBoxList.innerHTML="",Object.keys(jsonList).forEach(t=>{const e=document.createElement("option");e.value=t.replace(/ಠ/g," "),e.value=e.value.replace(/ಠ/g," "),comboBoxList.appendChild(e)})}})),!1),clearButton.addEventListener("click",()=>__awaiter(this,void 0,void 0,(function*(){comboBoxInput.value="",quickShoutText.value="";const t=new Event("input");comboBoxInput.dispatchEvent(t)})),!1),comboBoxInput.addEventListener("input",()=>__awaiter(this,void 0,void 0,(function*(){if(comboBoxInput.value){const t=comboBoxInput.value.replace(/ /g,"ಠ");quickShoutText.style.display="",shoutFoot.style.height="11em",jsonList[t]?(quickShoutText.value=decodeURIComponent(jsonList[t]),deleteButton.style.display="",saveButton.style.backgroundColor="Green",saveButton.style.color=""):(saveButton.style.backgroundColor="Orange",saveButton.style.color="Black",deleteButton.style.display="none")}else quickShoutText.value?(saveButton.style.backgroundColor="Orange",saveButton.style.color="Black"):(quickShoutText.style.display="none",shoutFoot.style.height="2.5em",saveButton.style.backgroundColor="",saveButton.style.color=""),deleteButton.style.display="none"})),!1),quickShoutText.addEventListener("input",()=>__awaiter(this,void 0,void 0,(function*(){const t=comboBoxInput.value.replace(/ /g,"ಠ");comboBoxInput.value?jsonList[t]&&quickShoutText.value!==decodeURIComponent(jsonList[t])?(saveButton.style.backgroundColor="Yellow",saveButton.style.color="Black",deleteButton.style.display=""):jsonList[t]&&quickShoutText.value===decodeURIComponent(jsonList[t])?(saveButton.style.backgroundColor="Green",saveButton.style.color="",deleteButton.style.display=""):jsonList[t]||(saveButton.style.backgroundColor="Orange",saveButton.style.color="Black",deleteButton.style.display="none"):(saveButton.style.backgroundColor="Orange",saveButton.style.color="Black",deleteButton.style.display="none")})),!1),shoutFoot.appendChild(comboBoxDiv),shoutFoot.appendChild(quickShoutText)}))}get settings(){return this._settings}}class ToggleSnatched{constructor(){this._settings={scope:SettingGroup.Search,type:"checkbox",title:"toggleSnatched",desc:"Add a button to hide/show results that you've snatched"},this._tar="#ssr",this._isVisible=!0,this._snatchedHook='td div[class^="browse"]',this._share=new Shared,Util.startFeature(this._settings,this._tar,["browse"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){let t,e,s;"false"===GM_getValue(`${this._settings.title}State`)&&!0===GM_getValue("stickySnatchedToggle")?this._setVisState(!1):this._setVisState(!0);const o=this._isVisible?"Hide Snatched":"Show Snatched";yield Promise.all([t=Util.createButton("snatchedToggle",o,"h1","#resetNewIcon","beforebegin","torFormButton"),e=this._share.getSearchList()]),t.then(t=>{t.addEventListener("click",()=>{!0===this._isVisible?(t.innerHTML="Show Snatched",this._setVisState(!1)):(t.innerHTML="Hide Snatched",this._setVisState(!0)),this._filterResults(s,this._snatchedHook)},!1)}).catch(t=>{throw new Error(t)}),e.then(t=>__awaiter(this,void 0,void 0,(function*(){s=t,this._searchList=t,this._filterResults(s,this._snatchedHook),console.log("[M+] Added the Toggle Snatched button!")}))).then(()=>{Check.elemObserver("#ssr",()=>{e=this._share.getSearchList(),e.then(t=>__awaiter(this,void 0,void 0,(function*(){s=t,this._searchList=t,this._filterResults(s,this._snatchedHook)})))})})}))}_filterResults(t,e){t.forEach(t=>{const s=document.querySelector("#mp_snatchedToggle");null!==t.querySelector(e)&&(!1===this._isVisible?(s.innerHTML="Show Snatched",t.style.display="none"):(s.innerHTML="Hide Snatched",t.style.display="table-row"))})}_setVisState(t){MP.DEBUG&&console.log("Snatch vis state:",this._isVisible,"\nval:",t),GM_setValue(`${this._settings.title}State`,`${t}`),this._isVisible=t}get settings(){return this._settings}get searchList(){if(void 0===this._searchList)throw new Error("searchlist is undefined");return this._searchList}get visible(){return this._isVisible}set visible(t){this._setVisState(t)}}class StickySnatchedToggle{constructor(){this._settings={scope:SettingGroup.Search,type:"checkbox",title:"stickySnatchedToggle",desc:"Make toggle state persist between page loads"},this._tar="#ssr",Util.startFeature(this._settings,this._tar,["browse"]).then(t=>{t&&this._init()})}_init(){console.log("[M+] Remembered snatch visibility state!")}get settings(){return this._settings}}class PlaintextSearch{constructor(){this._settings={scope:SettingGroup.Search,type:"checkbox",title:"plaintextSearch",desc:"Insert plaintext search results at top of page"},this._tar="#ssr h1",this._isOpen=GM_getValue(`${this._settings.title}State`),this._share=new Shared,this._plainText="",Util.startFeature(this._settings,this._tar,["browse"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){let t,e,s;yield Promise.all([t=Util.createButton("plainToggle","Show Plaintext","div","#ssr","beforebegin","mp_toggle mp_plainBtn"),s=this._share.getSearchList()]),s.then(t=>__awaiter(this,void 0,void 0,(function*(){e=yield Util.createButton("plainCopy","Copy Plaintext","div","#mp_plainToggle","afterend","mp_copy mp_plainBtn"),e.insertAdjacentHTML("afterend","<br><textarea class='mp_plaintextSearch' style='display: none'></textarea>"),this._plainText=yield this._processResults(t),document.querySelector(".mp_plaintextSearch").innerHTML=this._plainText,Util.clipboardifyBtn(e,this._plainText)}))).then(()=>{Check.elemObserver("#ssr",()=>{document.querySelector(".mp_plaintextSearch").innerHTML="",s=this._share.getSearchList(),s.then(t=>__awaiter(this,void 0,void 0,(function*(){this._plainText=yield this._processResults(t),document.querySelector(".mp_plaintextSearch").innerHTML=this._plainText})))})}),this._setOpenState(this._isOpen),t.then(t=>{t.addEventListener("click",()=>{const e=document.querySelector(".mp_plaintextSearch");if(null===e)throw new Error("textbox doesn't exist!");"false"===this._isOpen?(this._setOpenState("true"),e.style.display="block",t.innerText="Hide Plaintext"):(this._setOpenState("false"),e.style.display="none",t.innerText="Show Plaintext")},!1)}).catch(t=>{throw new Error(t)}),console.log("[M+] Inserted plaintext search results!")}))}_setOpenState(t){void 0===t&&(t="false"),GM_setValue("toggleSnatchedState",t),this._isOpen=t}_processResults(t){return __awaiter(this,void 0,void 0,(function*(){let e="";return t.forEach(t=>{let s="",o="",i="",n="";const r=t.querySelector(".torTitle"),a=t.querySelectorAll(".series"),l=t.querySelectorAll(".author"),c=t.querySelectorAll(".narrator");if(null===r)throw console.warn("Error Node:",t),new Error("Result title should not be null");s=r.textContent.trim(),null!==a&&a.length>0&&(a.forEach(t=>{o+=`${t.textContent} / `}),o=o.substring(0,o.length-3),o=` (${o})`),null!==l&&l.length>0&&(i="BY ",l.forEach(t=>{i+=`${t.textContent} AND `}),i=i.substring(0,i.length-5)),null!==c&&c.length>0&&(n="FT ",c.forEach(t=>{n+=`${t.textContent} AND `}),n=n.substring(0,n.length-5)),e+=`${s}${o} ${i} ${n}\n`}),e}))}get settings(){return this._settings}get isOpen(){return this._isOpen}set isOpen(t){this._setOpenState(t)}}class ToggleSearchbox{constructor(){this._settings={scope:SettingGroup.Search,type:"checkbox",title:"toggleSearchbox",desc:"Collapse the Search box and make it toggleable"},this._tar="#torSearchControl",this._height="26px",this._isOpen="false",Util.startFeature(this._settings,this._tar,["browse"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=document.querySelector(this._tar);if(t){const e=t.querySelector(".blockHeadCon h4");e?(e.innerHTML="Toggle Search",e.style.cursor="pointer",e.addEventListener("click",()=>{this._toggle(t)})):console.error("Could not set up toggle! Target does not exist"),Util.setAttr(t,{style:`height:${this._height};overflow:hidden;`});const s=document.querySelector("#mainBody > h3"),o=document.querySelector("#mainBody > h3 ~ a");s&&(s.style.display="none"),o&&(o.style.display="none"),console.log("[M+] Collapsed the Search box!")}else console.error("Could not collapse Search box! Target does not exist")}))}_toggle(t){return __awaiter(this,void 0,void 0,(function*(){"false"===this._isOpen?(t.style.height="unset",this._isOpen="true"):(t.style.height=this._height,this._isOpen="false"),MP.DEBUG&&console.log("Toggled Search box!")}))}get settings(){return this._settings}}class BuildTags{constructor(){this._settings={scope:SettingGroup.Search,type:"checkbox",title:"buildTags",desc:"Generate clickable Tags automatically"},this._tar="#ssr",this._share=new Shared,this._processTagString=t=>{const e=t.querySelector(".torRowDesc");MP.DEBUG&&console.group(e);let s=e.innerHTML.replace(/(?:\[|\]|\(|\)|$)/gi,",");s=s.split(/(?:&.{1,5};)/g).join(";");let o=s.split(/\s*(?:;|,|>|\||$)\s*/);o=o.filter(t=>t.length<=30&&t.length>0),null===t.querySelector(".mp_tags")&&this._injectLinks(o,e),MP.DEBUG&&(console.log(o),console.groupEnd())},this._injectLinks=(t,e)=>{if(t.length>0){const s=document.createElement("span");s.classList.add("mp_tags"),e.insertAdjacentElement("beforebegin",s),e.style.display="none",s.insertAdjacentElement("afterend",document.createElement("br")),t.forEach(t=>{s.innerHTML+=`<a class='mp_tag' href='/tor/browse.php?tor%5Btext%5D=%22${encodeURIComponent(t)}%22&tor%5BsrchIn%5D%5Btags%5D=true'>${t}</a>`})}},Util.startFeature(this._settings,this._tar,["browse"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){let t=this._share.getSearchList();t.then(t=>{t.forEach(t=>this._processTagString(t)),console.log("[M+] Built tag links!")}).then(()=>{Check.elemObserver("#ssr",()=>{t=this._share.getSearchList(),t.then(t=>{t.forEach(t=>this._processTagString(t)),console.log("[M+] Built tag links!")})})})}))}get settings(){return this._settings}}class RandomBook{constructor(){this._settings={scope:SettingGroup.Search,type:"checkbox",title:"randomBook",desc:"Add a button to open a randomly selected book page. (<em>Uses the currently selected category in the dropdown</em>)"},this._tar="#ssr",Util.startFeature(this._settings,this._tar,["browse"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){let t;yield Promise.all([t=Util.createButton("randomBook","Random Book","h1","#resetNewIcon","beforebegin","torFormButton")]),t.then(t=>{t.addEventListener("click",()=>{let t,e="";const s=document.getElementById("categoryPartial"),o=s.options[s.selectedIndex].value;switch(String(o)){case"ALL":case"defaults":e="";break;case"m13":e="&tor[main_cat][]=13";break;case"m14":e="&tor[main_cat][]=14";break;case"m15":e="&tor[main_cat][]=15";break;case"m16":e="&tor[main_cat][]=16";break;default:"c"===o.charAt(0)&&(e="&tor[cat][]="+o.substring(1))}Promise.all([t=this._getRandomBookResults(e)]),t.then(t=>{window.open("https://www.myanonamouse.net/t/"+t,"_blank")}).catch(t=>{throw new Error(t)})},!1),console.log("[M+] Added the Random Book button!")}).catch(t=>{throw new Error(t)})}))}_getRandomBookResults(t){return __awaiter(this,void 0,void 0,(function*(){return new Promise((e,s)=>{let o;const i=`https://www.myanonamouse.net/tor/js/loadSearchJSONbasic.php?tor[searchType]=all&tor[searchIn]=torrents${t}&tor[perpage]=5&tor[browseFlagsHideVsShow]=0&tor[startDate]=&tor[endDate]=&tor[hash]=&tor[sortType]=random&thumbnail=true?${Util.randomNumber(1,1e5)}`;Promise.all([o=Util.getJSON(i)]).then(()=>{o.then(t=>{e(JSON.parse(t).data[0].id)}).catch(t=>{throw new Error(t)})})})}))}get settings(){return this._settings}}class ToggleHiddenRequesters{constructor(){this._settings={scope:SettingGroup.Requests,type:"checkbox",title:"toggleHiddenRequesters",desc:"Hide hidden requesters"},this._tar="#torRows",this._hide=!0,Util.startFeature(this._settings,this._tar,["request"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){this._addToggleSwitch(),this._searchList=yield this._getRequestList(),this._filterResults(this._searchList),Check.elemObserver(this._tar,()=>__awaiter(this,void 0,void 0,(function*(){this._searchList=yield this._getRequestList(),this._filterResults(this._searchList)})))}))}_addToggleSwitch(){Util.createButton("showHidden","Show Hidden","div","#requestSearch .torrentSearch","afterend","torFormButton");const t=document.querySelector("#mp_showHidden");t.addEventListener("click",()=>{const e=document.querySelectorAll("#torRows > .mp_hidden");this._hide?(this._hide=!1,t.innerText="Hide Hidden",e.forEach(t=>{t.style.display="list-item",t.style.opacity="0.5"})):(this._hide=!0,t.innerText="Show Hidden",e.forEach(t=>{t.style.display="none",t.style.opacity="0"}))})}_getRequestList(){return new Promise((t,e)=>{Check.elemLoad("#torRows .torRow .torRight").then(()=>{const s=document.querySelectorAll("#torRows .torRow");null==s?e(`reqList is ${s}`):t(s)})})}_filterResults(t){t.forEach(t=>{null===t.querySelector(".torRight a")&&(t.style.display="none",t.classList.add("mp_hidden"))})}get settings(){return this._settings}}class PlaintextRequest{constructor(){this._settings={scope:SettingGroup.Requests,type:"checkbox",title:"plaintextRequest",desc:"Insert plaintext request results at top of request page"},this._tar="#ssr",this._isOpen=GM_getValue(`${this._settings.title}State`),this._plainText="",this._getRequestList=()=>(MP.DEBUG&&console.log("Shared.getSearchList( )"),new Promise((t,e)=>{Check.elemLoad("#torRows .torRow a").then(()=>{const s=document.querySelectorAll("#torRows .torRow");null==s?e(`snatchList is ${s}`):t(s)})})),Util.startFeature(this._settings,this._tar,["request"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){let t,e,s;yield Promise.all([t=Util.createButton("plainToggle","Show Plaintext","div","#ssr","beforebegin","mp_toggle mp_plainBtn"),s=this._getRequestList()]),s.then(t=>__awaiter(this,void 0,void 0,(function*(){e=yield Util.createButton("plainCopy","Copy Plaintext","div","#mp_plainToggle","afterend","mp_copy mp_plainBtn"),e.insertAdjacentHTML("afterend","<br><textarea class='mp_plaintextSearch' style='display: none'></textarea>"),this._plainText=yield this._processResults(t),document.querySelector(".mp_plaintextSearch").innerHTML=this._plainText,Util.clipboardifyBtn(e,this._plainText)}))).then(()=>{Check.elemObserver("#ssr",()=>{document.querySelector(".mp_plaintextSearch").innerHTML="",s=this._getRequestList(),s.then(t=>__awaiter(this,void 0,void 0,(function*(){this._plainText=yield this._processResults(t),document.querySelector(".mp_plaintextSearch").innerHTML=this._plainText})))})}),this._setOpenState(this._isOpen),t.then(t=>{t.addEventListener("click",()=>{const e=document.querySelector(".mp_plaintextSearch");if(null===e)throw new Error("textbox doesn't exist!");"false"===this._isOpen?(this._setOpenState("true"),e.style.display="block",t.innerText="Hide Plaintext"):(this._setOpenState("false"),e.style.display="none",t.innerText="Show Plaintext")},!1)}).catch(t=>{throw new Error(t)}),console.log("[M+] Inserted plaintext request results!")}))}_setOpenState(t){void 0===t&&(t="false"),GM_setValue("toggleSnatchedState",t),this._isOpen=t}_processResults(t){return __awaiter(this,void 0,void 0,(function*(){let e="";return t.forEach(t=>{let s="",o="",i="",n="";const r=t.querySelector(".torTitle"),a=t.querySelectorAll(".series"),l=t.querySelectorAll(".author"),c=t.querySelectorAll(".narrator");if(null===r)throw console.warn("Error Node:",t),new Error("Result title should not be null");s=r.textContent.trim(),null!==a&&a.length>0&&(a.forEach(t=>{o+=`${t.textContent} / `}),o=o.substring(0,o.length-3),o=` (${o})`),null!==l&&l.length>0&&(i="BY ",l.forEach(t=>{i+=`${t.textContent} AND `}),i=i.substring(0,i.length-5)),null!==c&&c.length>0&&(n="FT ",c.forEach(t=>{n+=`${t.textContent} AND `}),n=n.substring(0,n.length-5)),e+=`${s}${o} ${i} ${n}\n`}),e}))}get settings(){return this._settings}get isOpen(){return this._isOpen}set isOpen(t){this._setOpenState(t)}}class GoodreadsButtonReq{constructor(){this._settings={type:"checkbox",title:"goodreadsButtonReq",scope:SettingGroup.Requests,desc:"Enable MAM-to-Goodreads buttons for requests"},this._tar="#fillTorrent",this._share=new Shared,Util.startFeature(this._settings,this._tar,["request details"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=Util.rowsToObj(document.querySelectorAll("#torDetMainCon > div")),e=t["Title:"].querySelector("span"),s=t["Author(s):"].querySelectorAll("a"),o=t["Series:"]?t["Series:"].querySelectorAll("a"):null,i=t["Release Date"];this._share.goodreadsButtons(e,s,o,i)}))}get settings(){return this._settings}}class SimpleVault{constructor(){this._settings={scope:SettingGroup.Vault,type:"checkbox",title:"simpleVault",desc:"Simplify the Vault pages. (<em>This removes everything except the donate button &amp; list of recent donations</em>)"},this._tar="#mainBody",Util.startFeature(this._settings,this._tar,["vault"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=GM_getValue("mp_currentPage"),e=document.querySelector(this._tar);console.group(`Applying Vault (${t}) settings...`);const s=e.querySelector("form"),o=e.querySelector("table:last-of-type");if(e.innerHTML="",null!==s){const t=s.cloneNode(!0);e.appendChild(t),t.classList.add("mp_vaultClone")}else e.innerHTML="<h1>Come back tomorrow!</h1>";if(null!==o){const t=o.cloneNode(!0);e.appendChild(t),t.classList.add("mp_vaultClone")}else e.style.paddingBottom="25px";console.log("[M+] Simplified the vault page!")}))}get settings(){return this._settings}}class SearchForDuplicates{constructor(){this._settings={type:"checkbox",title:"searchForDuplicates",scope:SettingGroup["Upload Page"],desc:"Easier searching for duplicates when uploading content"},this._tar='#uploadForm input[type="submit"]',Util.startFeature(this._settings,this._tar,["upload"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){const t=document.querySelector("#mainBody");t&&(this._generateSearch({parentElement:t,title:"Check for results with given title",type:"title",inputSelector:'input[name="tor[title]"]',rowPosition:7,useWildcard:!0}),this._generateSearch({parentElement:t,title:"Check for results with given author(s)",type:"author",inputSelector:"input.ac_author",rowPosition:10}),this._generateSearch({parentElement:t,title:"Check for results with given series",type:"series",inputSelector:"input.ac_series",rowPosition:11}),this._generateSearch({parentElement:t,title:"Check for results with given narrator(s)",type:"narrator",inputSelector:"input.ac_narrator",rowPosition:12})),console.log("[M+] Adding search to uploads!")}))}_generateSearch({parentElement:t,title:e,type:s,inputSelector:o,rowPosition:i,useWildcard:n=!1}){var r;const a=document.createElement("a");Util.setAttr(a,{target:"_blank",style:"text-decoration: none; cursor: pointer;",title:e}),a.textContent=" 🔍";const l=`/tor/browse.php?tor%5BsearchType%5D=all&tor%5BsearchIn%5D=torrents&tor%5Bcat%5D%5B%5D=0&tor%5BbrowseFlagsHideVsShow%5D=0&tor%5BsortType%5D=dateDesc&tor%5BsrchIn%5D%5B${s}%5D=true&tor%5Btext%5D=`;null===(r=t.querySelector(`#uploadForm > tbody > tr:nth-child(${i}) > td:nth-child(1)`))||void 0===r||r.insertAdjacentElement("beforeend",a),a.addEventListener("click",e=>{const s=t.querySelectorAll(o);if(s&&s.length){const t=[];if(s.forEach(e=>{e.value&&t.push(e.value)}),t.join(" ").trim()){const e=n?`*${encodeURIComponent(t.join(" "))}*`:encodeURIComponent(t.join(" "));a.setAttribute("href",l+e)}else e.preventDefault(),e.stopPropagation()}else e.preventDefault(),e.stopPropagation()})}get settings(){return this._settings}}class UserGiftDefault{constructor(){this._settings={scope:SettingGroup["User Pages"],type:"textbox",title:"userGiftDefault",tag:"Default Gift",placeholder:"ex. 1000, max",desc:"Autofills the Gift box with a specified number of points. (<em>Or the max allowable value, whichever is lower</em>)"},this._tar="#bonusgift",Util.startFeature(this._settings,this._tar,["user"]).then(t=>{t&&this._init()})}_init(){(new Shared).fillGiftBox(this._tar,this._settings.title).then(t=>console.log(`[M+] Set the default gift amount to ${t}`))}get settings(){return this._settings}}class UserGiftHistory{constructor(){this._settings={type:"checkbox",title:"userGiftHistory",scope:SettingGroup["User Pages"],desc:"Display gift history between you and another user"},this._sendSymbol="<span style='color:orange'>⟰</span>",this._getSymbol="<span style='color:teal'>⟱</span>",this._tar="tbody",Util.startFeature(this._settings,this._tar,["user"]).then(t=>{t&&this._init()})}_init(){return __awaiter(this,void 0,void 0,(function*(){console.log("[M+] Initiallizing user gift history...");const t=document.querySelector("#mainBody > h1").textContent.trim(),e=document.createElement("tr"),s=document.querySelector("#mainBody tbody tr:last-of-type");s&&s.insertAdjacentElement("beforebegin",e);const o=document.createElement("td");o.classList.add("rowhead"),o.textContent="Gift history",e.appendChild(o);const i=document.createElement("td");i.classList.add("row1"),i.textContent=`You have not exchanged gifts with ${t}.`,i.align="left",e.appendChild(i);const n=window.location.pathname.split("/").pop();if(!n)throw new Error(`User ID not found: ${n}`);{const e=yield Util.getUserGiftHistory(n);if(e.length){const[s,o]=this._sumGifts(e,"giftPoints"),[n,r]=this._sumGifts(e,"giftWedge");MP.DEBUG&&(console.log(`Points In/Out: ${s}/${o}`),console.log(`Wedges In/Out: ${n}/${r}`)),i.innerHTML=`You have sent ${this._sendSymbol} <strong>${o} points</strong> &amp; <strong>${r} FL wedges</strong> to ${t} and received ${this._getSymbol} <strong>${s} points</strong> &amp; <strong>${n} FL wedges</strong>.<hr>`,i.appendChild(this._showGifts(e)),console.log("[M+] User gift history added!")}else console.log("[M+] No user gift history found.")}}))}_sumGifts(t,e){const s=[0],o=[0];t.map(t=>{t.type===e&&(t.amount>0?o.push(t.amount):s.push(t.amount))});const i=s.reduce((t,e)=>t+e);return[o.reduce((t,e)=>t+e),Math.abs(i)]}_showGifts(t){const e=t=>"giftPoints"===t.type?`${Math.abs(t.amount)}`:"giftWedge"===t.type?"(FL)":`Error: unknown gift type... ${t.type}: ${t.amount}`,s=document.createElement("ul");Object.assign(s.style,{listStyle:"none",padding:"initial",height:"10em",overflow:"auto"});const o=t.map(t=>{let s="";return s=t.amount>0?`${this._getSymbol} ${e(t)}`:`${this._sendSymbol} ${e(t)}`,`<li class='mp_giftItem'>${Util.prettySiteTime(t.timestamp,!0)} ${s}</li>`});return s.innerHTML=o.join(""),s}get settings(){return this._settings}}class InitFeatures{constructor(){new HideHome,new HideSeedbox,new BlurredHeader,new VaultLink,new MiniVaultInfo,new BonusPointDelta,new FixedNav,new HideNews,new GiftNewest,new ToggleSnatched,new StickySnatchedToggle,new PlaintextSearch,new ToggleSearchbox,new BuildTags,new RandomBook,new GoodreadsButtonReq,new ToggleHiddenRequesters,new PlaintextRequest,new GoodreadsButton,new CurrentlyReading,new TorGiftDefault,new RatioProtect,new RatioProtectL1,new RatioProtectL2,new RatioProtectL3,new RatioProtectMin,new PriorityUsers,new PriorityStyle,new MutedUsers,new ReplySimple,new ReplyQuote,new GiftButton,new QuickShout,new SimpleVault,new UserGiftDefault,new UserGiftHistory,new ForumFLGift,new SearchForDuplicates}}class Settings{static _getScopes(t){return MP.DEBUG&&console.log("_getScopes(",t,")"),new Promise(e=>{const s={};for(const e of t){const t=Number(e.scope);s[t]?s[t].push(e):s[t]=[e]}e(s)})}static _buildTable(t){return MP.DEBUG&&console.log("_buildTable(",t,")"),new Promise(e=>{let s=`<tbody><tr><td class="row1" colspan="2"><br><strong>MAM+ v${MP.VERSION}</strong> - Here you can enable &amp; disable any feature from the <a href="/f/t/41863">MAM+ userscript</a>! However, these settings are <strong>NOT</strong> stored on MAM; they are stored within the Tampermonkey/Greasemonkey extension in your browser, and must be customized on each of your browsers/devices separately.<br><br>For a detailed look at the available features, <a href="https://github.com/gardenshade/mam-plus/wiki/Feature-Overview">check the Wiki!</a><br><br></td></tr>`;Object.keys(t).forEach(e=>{const o=Number(e);s+=`<tr><td class='row2'>${SettingGroup[o]}</td><td class='row1'>`,Object.keys(t[o]).forEach(e=>{const i=Number(e),n=t[o][i],r={checkbox:()=>{s+=`<input type='checkbox' id='${n.title}' value='true'>${n.desc}<br>`},textbox:()=>{s+=`<span class='mp_setTag'>${n.tag}:</span> <input type='text' id='${n.title}' placeholder='${n.placeholder}' class='mp_textInput' size='25'>${n.desc}<br>`},dropdown:()=>{s+=`<span class='mp_setTag'>${n.tag}:</span> <select id='${n.title}' class='mp_dropInput'>`,n.options&&Object.keys(n.options).forEach(t=>{s+=`<option value='${t}'>${n.options[t]}</option>`}),s+=`</select>${n.desc}<br>`}};n.type&&r[n.type]()}),s+="</td></tr>"}),s+='<tr><td class="row1" colspan="2"><div id="mp_submit" class="mp_settingBtn">Save M+ Settings??</div><div id="mp_copy" class="mp_settingBtn">Copy Settings</div><div id="mp_inject" class="mp_settingBtn">Paste Settings</div><span class="mp_savestate" style="opacity:0">Saved!</span></td></tr></tbody>',e(s)})}static _getSettings(t){const e=GM_listValues();MP.DEBUG&&console.log("_getSettings(",t,")\nStored GM keys:",e),Object.keys(t).forEach(e=>{Object.keys(t[Number(e)]).forEach(s=>{const o=t[Number(e)][Number(s)];if(MP.DEBUG&&console.log("Pref:",o.title,"| Set:",GM_getValue(`${o.title}`),"| Value:",GM_getValue(`${o.title}_val`)),null!==o&&"object"==typeof o){const t=document.getElementById(o.title),e={checkbox:()=>{t.setAttribute("checked","checked")},textbox:()=>{t.value=GM_getValue(`${o.title}_val`)},dropdown:()=>{t.value=GM_getValue(o.title)}};e[o.type]&&GM_getValue(o.title)&&e[o.type]()}})})}static _setSettings(t){MP.DEBUG&&console.log("_setSettings(",t,")"),Object.keys(t).forEach(e=>{Object.keys(t[Number(e)]).forEach(s=>{const o=t[Number(e)][Number(s)];if(null!==o&&"object"==typeof o){const t=document.getElementById(o.title),e={checkbox:()=>{t.checked&&GM_setValue(o.title,!0)},textbox:()=>{const e=t.value;""!==e&&(GM_setValue(o.title,!0),GM_setValue(`${o.title}_val`,e))},dropdown:()=>{GM_setValue(o.title,t.value)}};e[o.type]&&e[o.type]()}})}),console.log("[M+] Saved!")}static _copySettings(){const t=GM_listValues(),e=[];return t.map(t=>{t.indexOf("mp_")<0&&e.push([t,GM_getValue(t)])}),JSON.stringify(e)}static _pasteSettings(t){MP.DEBUG&&console.group("_pasteSettings( )"),JSON.parse(t).forEach(t=>{t[1]&&(GM_setValue(`${t[0]}`,`${t[1]}`),MP.DEBUG&&console.log(t[0],": ",t[1]))})}static _saveSettings(t,e){MP.DEBUG&&console.group("_saveSettings()");const s=document.querySelector("span.mp_savestate"),o=GM_listValues();s.style.opacity="0",window.clearTimeout(t),console.log("[M+] Saving...");for(const t in o)"function"!=typeof o[t]&&(["mp_version","style_theme"].includes(o[t])||0!==o[t].indexOf("mp_")&&GM_setValue(o[t],!1));this._setSettings(e),s.style.opacity="1";try{t=window.setTimeout(()=>{s.style.opacity="0"},2345)}catch(t){MP.DEBUG&&console.warn(t)}MP.DEBUG&&console.groupEnd()}static init(t,e){return __awaiter(this,void 0,void 0,(function*(){!0===t&&(MP.DEBUG&&console.group("new Settings()"),yield Check.elemLoad("#mainBody > table").then(t=>{MP.DEBUG&&console.log("[M+] Starting to build Settings table...");const s=document.querySelector("#mainBody > table"),o=document.createElement("h1"),i=document.createElement("table");let n;s.insertAdjacentElement("afterend",o),o.insertAdjacentElement("afterend",i),Util.setAttr(i,{class:"coltable",cellspacing:"1",style:"width:100%;min-width:100%;max-width:100%;"}),o.innerHTML="MAM+ Settings",this._getScopes(e).then(t=>(n=t,this._buildTable(t))).then(t=>(i.innerHTML=t,console.log("[M+] Added the MAM+ Settings table!"),n)).then(t=>(this._getSettings(t),t)).then(t=>{const e=document.querySelector("#mp_submit"),s=document.querySelector("#mp_copy"),o=document.querySelector("#mp_inject");try{e.addEventListener("click",()=>{this._saveSettings(void 0,t)},!1),Util.clipboardifyBtn(o,this._pasteSettings,!1),Util.clipboardifyBtn(s,this._copySettings())}catch(t){MP.DEBUG&&console.warn(t)}MP.DEBUG&&console.groupEnd()})}))}))}}!function(t){t.DEBUG=!!GM_getValue("debug"),t.CHANGELOG={UPDATE_LIST:["🐞: Fixed an issue where the sticky navbar would appear on top of the fullscreen shoutbox."],BUG_LIST:[]},t.TIMESTAMP="Oct 1",t.VERSION=Check.newVer,t.PREV_VER=Check.prevVer,t.ERRORLOG=[],t.PAGE_PATH=window.location.pathname,t.MP_CSS=new Style,t.settingsGlob=[],t.run=()=>__awaiter(this,void 0,void 0,(function*(){console.group(`Welcome to MAM+ v${t.VERSION}!`),GM_deleteValue("mp_currentPage"),Check.page(),document.cookie="mp_enabled=1;domain=myanonamouse.net;path=/;samesite=lax";const e=new Alerts;new Debug,Check.updated().then(s=>{s&&e.notify(s,t.CHANGELOG)}),new InitFeatures,Check.page("settings").then(e=>{const s=window.location.search;!0!==e||""!==s&&"?view=general"!==s||Settings.init(e,t.settingsGlob)}),Check.elemLoad('head link[href*="ICGstation"]').then(()=>{t.MP_CSS.injectLink(),t.MP_CSS.alignToSiteTheme()}),console.groupEnd()}))}(MP||(MP={})),MP.run();