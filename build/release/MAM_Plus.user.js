// ==UserScript==
// @name         MAM Plus2
// @namespace    https://github.com/gardenshade
// @version      3.1.1
// @description  Lots of tiny fixes for MAM
// @author       GardenShade
// @include      https://myanonamouse.net/*
// @include      https://www.myanonamouse.net/*
// @icon         http://i.imgur.com/dX44pSv.png
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_listValues
// @grant        GM_deleteValue
// @grant        GM_addStyle
// @grant        GM_info
// ==/UserScript==
var MP={},MP_DEBUG=!!GM_getValue("mp_debug");try{var MP_CHECK;MP_CHECK={version:function(){!0===MP_DEBUG&&(console.group("MP_CHECK.version()"),console.log("PREV_VER: "+MP.PREV_VER),console.log("VERSION: "+MP.VERSION)),MP.PREV_VER!==MP.VERSION&&(!0===MP_DEBUG&&console.log("Dif versions; making notification..."),MP.PREV_VER?(!0===MP_DEBUG&&console.log("Not a first-time run"),!0===MP_DEBUG&&console.log("mp_alerts: "+GM_getValue("mp_alerts")),!0===GM_getValue("mp_alerts")&&MP.triggerNote("update")):(!0===MP_DEBUG&&console.log("First-time run"),GM_setValue("mp_gr_btns",!0),GM_setValue("mp_alerts",!0),MP.triggerNote("firstRun")),GM_setValue("mp_version",MP.VERSION),!0===MP_DEBUG&&console.groupEnd())},page:function(e){var t,n,o;if(MP_PAGE.global(),n=e.split("/")[1],o=e.split("/")[2],t={"":MP_PAGE.home,shoutbox:MP_PAGE.shoutbox,t:MP_PAGE.torrent,preferences:MP_PAGE.settings,u:MP_PAGE.user,tor:function(){if(0===o.indexOf("browse")&&MP_PAGE.browse("browse"),0===o.indexOf("request"))return MP_PAGE.browse("requests")},millionaires:function(){if(0===o.indexOf("pot")&&MP_PAGE.vault("pot"),0===o.indexOf("donate"))return MP_PAGE.vault("donate")}},t[n])return t[n]()}};var MP_HELPERS;MP_HELPERS={setAttr:function(e,t){var n;for(n in t)e.setAttribute(n,t[n])},insertAfter:function(e,t){return t.parentNode.insertBefore(e,t.nextSibling)},count:function(e,t){var n,o,r;for(r=[-1,0],n=r[0],o=r[1];-1!==o;)o=e.indexOf(t,o+1),n++;return n},reportCount:function(e,t,n){return 1!==t&&(n+="s"),console.log(">",e,t,n)},redoSpaces:function(e){return this.arrToStr(this.strToArr(e,"ws"),!0)},arrToStr:function(e,t){var n,o,r;for(o=[0,""],n=o[0],r=o[1];n<e.length;)r+=e[n],t&&n+1!==e.length&&(r+=" "),n++;return r},strToArr:function(e,t){var n,o,r,i;for(i=[],e=null!=t&&"ws"!==t?e.split(t):e=e.match(/\S+/g)||[],o=0,r=e.length;o<r;o++)n=e[o],i.push(n);return i},trimStr:function(e,t){return e.length>t&&(e=e.substring(0,t+1),e=e.substring(0,Math.min(e.length,e.lastIndexOf(" ")))),e},bracketRemover:function(e){return console.log("bracket remover"),console.log(e),e.replace(/{+.*?}+/g,"").replace(/\[\[|\]\]/g,"").replace(/<.*?>/g,"").replace(/\(.*?\)/g,"").trim()},pageLoad:function(e,t){var n,o,r;r=!1,o=setTimeout(function(){return!0===MP_DEBUG&&console.log("Page has timed out"),r=!0,e()},t);try{return document.onreadystatechange=function(){if("completed"===document.readyState)return!0===MP_DEBUG&&console.log("Page has loaded"),clearTimeout(o),e()}}catch(e){if(n=e,!0===MP_DEBUG)return console.warn(n)}}};var MP_PAGE;MP_PAGE={global:function(){var e,t;return console.group("Applying Global settings..."),t=document.querySelector("#millionInfo"),document.querySelector("#preNav .tP"),GM_getValue("mp_hide_banner")&&(document.body.classList.add("mp_hide_banner"),console.log("[M+] Hid the banner image!")),GM_getValue("mp_hide_home")&&(document.body.classList.add("mp_hide_home"),console.log("[M+] Hid the home button!")),GM_getValue("mp_hide_browse")&&(document.body.classList.add("mp_hide_browse"),console.log("[M+] Hid the browse button!")),GM_getValue("mp_vault_link")&&(t.setAttribute("href","/millionaires/donate.php"),console.log("[M+] Made the vault text link to the donate page!")),GM_getValue("mp_short_info")&&(e=parseInt(t.textContent.split(":")[1].split(" ")[1].replace(/,/g,"")),e=(e/1e6).toFixed(3),t.textContent="Vault: "+e+" million",console.log("[M+] Shortened the vault number!")),console.groupEnd()},home:function(){return console.group("Applying Home settings..."),MP.initShoutbox(),console.groupEnd()},shoutbox:function(){return console.group("Applying Shoutbox settings..."),MP.initShoutbox(),console.groupEnd()},browse:function(e){return console.group("Applying ("+e+") settings..."),"browse"===e&&MP.processResults(),"requests"===e&&console.log("No functions for requests"),console.groupEnd()},torrent:function(){var e,t,n,o,r;return console.group("Applying Torrent settings..."),e=document.querySelectorAll("#torDetMainCon .torAuthors a"),n=document.querySelector("#torDetMainCon .TorrentTitle"),o=document.querySelectorAll("#Series a"),t=document.querySelector("#torDetPoster"),r=Number(MP.pagePath.split("/")[2]),GM_getValue("mp_gr_btns")&&MP.addGoodreadsBtns(e,n,o),GM_getValue("mp_move_bookmark")&&(MP.moveBookmark(n,r),setInterval(function(){return MP.moveBookmark(n,r)},100),console.log("[M+] Updated the bookmark icon!")),GM_getValue("mp_placeholder_covers")&&!t.querySelector("img")&&MP.fakeCover(t,"missing"),"false"!==GM_getValue("mp_simple_download")&&void 0!==GM_getValue("mp_simple_download")&&MP.simpleDownload(GM_getValue("mp_simple_download")),console.groupEnd()},settings:function(){var e;if(console.group("Applying Preference Page settings..."),e=window.location.href,!0!==e.endsWith("preferences/index.php")&&!0!==e.endsWith("?view=general"))throw"Page is "+e;return!0===MP_DEBUG&&console.log("On General Settings page"),MP.insertSettings(),console.groupEnd()},user:function(){var e,t;return console.group("Applying User Page settings..."),GM_getValue("mp_gift_default")&&null!=(t=document.querySelector("#bonusgift"))&&(e=t.getAttribute("max"),t.value=e,console.log("[M+] Set the default gift amount to "+e)),console.groupEnd()},vault:function(e){var t,n,o,r,i;return console.group("Applying Vault ("+e+") settings..."),i=document.querySelector("#mainBody"),GM_getValue("mp_simple_vault")&&(t=i.querySelector("form"),n=i.querySelector("table:last-of-type"),i.innerHTML="",null!=t?(o=t.cloneNode(!0),i.appendChild(o),o.classList.add("mp_vaultClone")):i.innerHTML="<h1>Come back tomorrow!</h1>",null!=n?(r=n.cloneNode(!0),i.appendChild(r),r.classList.add("mp_vaultClone")):i.style.paddingBottom="25px",console.log("[M+] Simplified the vault page!")),console.groupEnd()}};var MP_SETTINGS;MP_SETTINGS={global:{pageTitle:"Global",alerts:{id:"mp_alerts",type:"checkbox",desc:"Enable the MAM+ Alert panel for update information, etc."},hideBanner:{id:"mp_hide_banner",type:"checkbox",desc:"Remove the header image. (<em>Not recommended if the below is enabled</em>)"},hideHome:{id:"mp_hide_home",type:"checkbox",desc:"Remove the home button. (<em>Not recommended if the above is enabled</em>)"},hideBrowse:{id:"mp_hide_browse",type:"checkbox",desc:"Remove the Browse button, because Browse &amp; Search are the same"},vaultLink:{id:"mp_vault_link",type:"checkbox",desc:"Make the Vault link bypass the Vault Info page"},shortInfo:{id:"mp_short_info",type:"checkbox",desc:"Shorten the Vault link text"}},browse:{pageTitle:"Browse &amp; Search",hideSnatched:{id:"mp_hide_snatched",type:"checkbox",desc:"Enable the Hide Snatched button"},plaintextSearch:{id:"mp_plaintext_search",type:"checkbox",desc:"Insert plaintext search results at top of page"}},torrent:{pageTitle:"Torrent Page",grBtn:{id:"mp_gr_btns",type:"checkbox",desc:"Enable the MAM-to-Goodreads buttons"}},shoutbox:{pageTitle:"Shoutbox",blockUsers:{id:"mp_block_users",type:"textbox",tag:"Block Users",desc:"Hides messages from the listed users in the shoutbox",placeholder:"ex. 1234, 108303, 10000"},priorityUsers:{id:"mp_priority_users",type:"textbox",tag:"Emphasize Users",desc:"Emphasizes messages from the listed users in the shoutbox",placeholder:"ex. 6, 25420, 77618"},priorityStyle:{id:"mp_priority_style",type:"textbox",tag:"Emphasis Style",desc:"Change the color/opacity of the highlighting rule for emphasized users' posts.<br>(<em>This is formatted as R,G,B,Opacity. RGB are 0-255 and Opacity is 0-1</em>)",placeholder:"default: 125, 125, 125, 0.3"}},vault:{pageTitle:"Mil. Vault",simpleVault:{id:"mp_simple_vault",type:"checkbox",desc:"Simplify the Vault pages. (<em>This removes everything except the donate button &amp; list of recent donations</em>)"}},user:{pageTitle:"User Pages",giftDefault:{id:"mp_gift_default",type:"checkbox",desc:"Select the largest possible gift amount by default"}},other:{pageTitle:"Other",debug:{id:"mp_debug",type:"checkbox",desc:"Error log (<em>Click this checkbox to enable verbose logging to the console</em>)"}}};var MP_STYLE;MP_STYLE={setStyle:function(){var e;return e=document.querySelector('head link[href*="ICGstation"]').getAttribute("href"),e.indexOf("dark")>0?(this.theme="dark",this.btnBorder="1px solid #bbaa77",this.btnColor="#aaa",this.btnBack="radial-gradient(ellipse at center,rgba(136,136,136,0) 0,rgba(136,136,136,0) 25%,rgba(136,136,136,0) 62%,rgba(136,136,136,0.65) 100%)",this.phColor="#8d5d5d"):(this.theme="light",this.btnBorder="1px solid #d0d0d0",this.btnColor="#000",this.btnBack="radial-gradient(ellipse at center,rgba(136,136,136,0) 0,rgba(136,136,136,0) 25%,rgba(136,136,136,0) 62%,rgba(136,136,136,0.65) 100%)",this.phColor="#575757"),GM_addStyle(".mp_notification{\n    position: fixed;\n    padding: 20px 40px;\n    width: 100%;\n    bottom:0;\n    left:0;\n    background: #333;\n    color: #bbb;\n    box-shadow: 0 0 4px 0 rgba(0,0,0,0.3);\n    z-index: 99998;\n}\n.mp_notification span{\n    position: absolute;\n    padding: 5px 10px;\n    display: inline-block;\n    top: -10px;\n    right: 90px;\n    background: #333;\n    color: red;\n    box-shadow: 0 0 4px 0 rgba(0,0,0,0.3);\n    border-radius: 50px;\n    cursor: pointer;\n    z-index: 99999;\n}\n.mp_hide_banner #msb{\n    visibility: hidden;\n    height: 10px;\n}\n.mp_hide_home #menu .homeLink{\n    display: none;\n}\n.mp_hide_browse #menu .mmTorrents li:first-of-type{\n    display: none;\n}\n.mp_setTag{\n    display: inline-block;\n    min-width:120px;\n}\n.mp_textInput,\n.mp_dropInput{\n    padding: 5px;\n    margin-right: 5px;\n    margin-top: 5px;\n}\n.mp_textInput ~ .mp_textInput{\n    margin-top: 0;\n}\n.mp_textInput::placeholder{\n    color: "+this.phColor+";\n}\n#mp_submit{\n    border: "+this.btnBorder+";\ncolor: "+this.btnColor+";\nbackground-image: "+this.btnBack+";\n    box-sizing: border-box;\n    padding: 0 8px;\n    display: inline-block;\n    height: 25px;\n    line-height: 25px;\n    cursor: pointer;\n}\n#mp_submit ~ .mp_savestate{\n    font-weight: bold;\n    color: green;\n    padding: 0 20px;\n    cursor: default;\n}\na.mp_button_clone{\n    border: "+this.btnBorder+";\ncolor: "+this.btnColor+";\nbackground-image: "+this.btnBack+';\n    box-sizing: border-box;\n    padding: 0 4px;\n    margin-right: 5px;\n}\n#mp_bookmark{\n    display: inline-block;\n    position: relative;\n    top: 3px;\n    padding-left: 20px;\n}\n.mp_cover{\n    display: inline-block;\n    width: 130px;\n    height: 200px;\n    line-height: 200px;\n    background: #333;\n    color: #777;\n    text-align: center;\n}\n.mp_vaultClone{\n    margin-top: 20px;\n}\n.mp_vaultClone input,.mp_vaultClone select{\n    font-size: 1.5em;\n    display: inline-block;\n    margin-right: 10px;\n}\n.mp_vaultClone br{\n    display: none;\n}\na[class^="mp_mark_"]{\n    position:relative;\n    top:4px;\n    left:5px;\n}\n.mp_formButton{\n    display:inline;\n    border-color: '+this.btnColor+';\n}\na[id^="torBookmark"].mp_mark_dark{\n    background:url(//cdn.myanonamouse.net/imagebucket/108303_mark_white.gif) no-repeat;\n    \n}\na[id^="torBookmark"].mp_mark_light{\n    background:url(//cdn.myanonamouse.net/imagebucket/108303_mark_black.gif) no-repeat;\n}\na[id^="torDeBookmark"].mp_mark_dark{\n    background:url(//cdn.myanonamouse.net/imagebucket/108303/mark_white_del.gif) no-repeat;\n    \n}\na[id^="torDeBookmark"].mp_mark_light{\n    background:url(//cdn.myanonamouse.net/imagebucket/108303/mark_black_del.gif) no-repeat;\n}'),this.theme}};var MP;MP={VERSION:GM_info.script.version,PREV_VER:GM_getValue("mp_version"),TIMESTAMP:"Dec 23th",UPDATE_LIST:["Temporarily hid Torrent Page settings that no longer work due to the new page style","Added the option to create a plaintext list of the displayed search results. Most people will want to leave this off."],BUG_LIST:[],errorLog:[],pagePath:window.location.pathname,run:function(){return console.group("Welcome to MAM+ v"+this.VERSION+"!"),document.cookie="mp_enabled=1;domain=myanonamouse.net;path=/",MP_STYLE.setStyle(),console.log("Theme is "+MP_STYLE.theme),MP_CHECK.version(),MP_CHECK.page(this.pagePath),console.groupEnd()},triggerNote:function(e){var t,n,o;if(!0===MP_DEBUG&&(console.group("MP.triggerNote()"),console.log("Note type is "+e)),t=function(e,t){var o,r,i;if(!0===MP_DEBUG&&console.log("buildMsg("+t+")"),e.length>0&&""!==e[0]){for(n+="<h4>"+t+":</h4><ul>",r=0,i=e.length;r<i;r++)o=e[r],n+="<li>"+o+"</li>";n+="</ul>"}},o=function(e){var t,n,o;!0===MP_DEBUG&&console.log("showPanel()"),document.body.innerHTML+="<div class='mp_notification'>"+e+"<span>X</span></div>",o=document.querySelector(".mp_notification"),t=o.querySelector("span");try{return t.addEventListener("click",function(){return o.remove()},!1)}catch(e){return n=e,!0===MP_DEBUG&&console.warn(n),!1}},n="","update"===e?(!0===MP_DEBUG&&console.log("update confirmed"),n+="<strong>MAM+ has been updated!</strong> You are now using v"+MP.VERSION+", published on "+MP.TIMESTAMP+". Discuss it on <a href='forums.php?action=viewtopic&topicid=41863'>the forums</a>.<hr>",t(MP.UPDATE_LIST,"Changes"),t(MP.BUG_LIST,"New Bugs")):"firstRun"===e&&(!0===MP_DEBUG&&console.log("firstRun confirmed"),n+='<h4>Welcome to MAM+!</h4>Please head over to your <a href="/preferences/index.php">preferences</a> to enable the MAM+ settings.<br>Any bug reports, feature requests, etc. can be made on <a href="/forums.php?action=viewtopic&topicid=41863">the forums</a> or <a href="/sendmessage.php?receiver=108303">through private message</a>.'),o(n),!0===MP_DEBUG)return console.groupEnd()},insertSettings:function(){var e,t,n,o,r,i,s,l,a,c;!0===MP_DEBUG&&console.group("MP.insertSettings()"),e=function(e){var t;return t='<tbody><tr><td class="row1" colspan="2">Here you can enable &amp; disable any feature from the <a href="/forums.php?action=viewtopic&topicid=41863&page=p376355#376355">MAM+ userscript</a>! However, these settings are <strong>NOT</strong> stored on MAM; they are stored within the Tampermonkey/Greasemonkey extension in your browser, and must be customized on each of your browsers/devices separately.</td></tr>',Object.keys(e).forEach(function(n){return t+="<tr><td class='row2'>"+e[n].pageTitle+"</td><td class='row1'>",Object.keys(e[n]).forEach(function(o){var r,i;if(i=e[n][o],r={checkbox:function(){return t+="<input type='checkbox' id='"+i.id+"' value='true'>"+i.desc+"<br>"},textbox:function(){return t+="<span class='mp_setTag'>"+i.tag+":</span> <input type='text' id='"+i.id+"' placeholder='"+i.placeholder+"' class='mp_textInput' size='25'>"+i.desc+"<br>"},dropdown:function(){var e,n,o;t+="<span class='mp_setTag'>"+i.tag+":</span> <select id='"+i.id+"' class='mp_dropInput'>",n=i.options;for(e in n)o=n[e],t+="<option value='"+e+"'>"+o+"</option>";return t+="</select>"+i.desc+"<br>"}},r[i.type])return r[i.type]()}),t+="</td></tr>"}),t+='<tr><td class="row1" colspan="2"><div id="mp_submit">Save M+ Settings</div><span class="mp_savestate" style="opacity:0">Saved!</span></td></tr></tbody>'},n=function(e){if(!0===MP_DEBUG&&console.group("getSettings()"),Object.keys(e).forEach(function(t){return Object.keys(e[t]).forEach(function(n){var o,r,i;if(null!==(i=e[t][n])&&"object"==typeof i&&(r=document.getElementById(i.id),o={checkbox:function(){return r.setAttribute("checked","checked")},textbox:function(){return r.value=GM_getValue(i.id+"_val")},dropdown:function(){return r.value=GM_getValue(""+i.id)}},o[i.type]&&GM_getValue(i.id)))return o[i.type]()})}),!0===MP_DEBUG)return console.endGroup},r=function(e){if(!0===MP_DEBUG&&console.group("setSettings()"),Object.keys(e).forEach(function(t){return Object.keys(e[t]).forEach(function(n){var o,r,i;if(null!==(i=e[t][n])&&"object"==typeof i&&(r=document.getElementById(i.id),o={checkbox:function(){if(r.checked)return GM_setValue(i.id,!0)},textbox:function(){var e;if(""!==(e=r.value))return GM_setValue(i.id,!0),GM_setValue(i.id+"_val",e)},dropdown:function(){return GM_setValue(i.id,r.value)}},o[i.type]))return o[i.type]()})}),!0===MP_DEBUG)return console.endGroup},o=function(e){var t,n,o;console.group("saveSettings()"),o=document.querySelector(".mp_savestate"),o.style.opacity="0",window.clearTimeout(e),console.log("Saving...");for(n in GM_listValues())"mp_version"!==GM_listValues()[n]&&GM_setValue(GM_listValues()[n],!1);console.log("Known settings:",GM_listValues()),r(MP_SETTINGS),console.log("Saved!"),o.style.opacity="1";try{e=window.setTimeout(function(){return o.style.opacity="0"},2345)}catch(e){t=e,!0===MP_DEBUG&&console.warn(t)}return console.endGroup},i=document.querySelector("#mainBody > table"),l=document.createElement("h1"),s=document.createElement("table"),MP_HELPERS.insertAfter(l,i),MP_HELPERS.insertAfter(s,l),MP_HELPERS.setAttr(s,{class:"coltable",cellspacing:"1",style:"width:100%;min-width:100%;max-width:100%;"}),l.innerHTML="MAM+ Settings",s.innerHTML=e(MP_SETTINGS),n(MP_SETTINGS),a="",c=document.querySelector("#mp_submit");try{c.addEventListener("click",function(){return o(a)},!1)}catch(e){t=e,!0===MP_DEBUG&&console.warn(t)}return!0===MP_DEBUG&&console.groupEnd(),console.log("[M+] Added the MAM+ Settings table!")},processResults:function(){var e,t,n,o;if(!0===MP_DEBUG&&console.log("processResults()"),o=!0,n=function(e,t){var n,r,i,s;console.log("toggling snatched"),s=document.querySelectorAll('#searchResults tr[id^="tdr"] td div[class^="browse"]'),!0===t&&MP_HELPERS.reportCount("Hiding",s.length,"snatched torrent"),!1===t&&MP_HELPERS.reportCount("Showing",s.length,"snatched torrent"),n=[];for(i in s)r=s[i].parentElement.parentElement,!0===t?(o=!1,r.style.display="none",e.innerHTML="Show Snatched"):(o=!0,r.removeAttribute("style"),e.innerHTML="Hide Snatched"),!0===MP_DEBUG?n.push(console.log(r)):n.push(void 0);return n},e=function(){var e,t,r;console.log("creating toggle"),e=document.querySelector("#resetNewIcon"),r=document.createElement("h1"),e.parentElement.insertBefore(r,e),MP_HELPERS.setAttr(r,{id:"mp_snatchedToggle",class:"torFormButton",role:"button"}),r.innerHTML="Hide Snatched";try{return r.addEventListener("click",function(){return n(r,o)},!1)}catch(e){if(t=e,!0===MP_DEBUG)return console.warn(t)}},t=function(){var e,t,n,o,r,i,s,l,a,c,u,d,p,g,h,m;for(c="### PLAINTEXT ###<br>",d=document.querySelectorAll("#searchResults tr[id^=tdr]"),o=0,s=d.length;o<s;o++){if(u=d[o],m=u.querySelector(".title").text,p="",e="",h=u.querySelectorAll(".series"),n=u.querySelectorAll(".author"),h.length>0){for(r=0,l=h.length;r<l;r++)g=h[r],p+=g.text+" / ";p=p.substring(0,p.length-3),p="("+p+")"}if(n.length>0){for(e="BY ",i=0,a=n.length;i<a;i++)t=n[i],e+=t.text+" AND ";e=e.substring(0,e.length-5)}c+=m+" "+p+" "+e+"<br>"}return document.querySelector("#searchResults > h1").insertAdjacentHTML("afterend","<div class='mp_plaintextSearch'>"+c+"########</div>"),console.log("[M+] Inserted plaintext search results!")},GM_getValue("mp_hide_snatched")&&e(),GM_getValue("mp_plaintext_search"))return MP_HELPERS.pageLoad(t,3e3)},addGoodreadsBtns:function(e,t,n){var o,r,i,s,l,a,c,u,d,p,g,h,m,_,f,b;for(s=null,_=null,r=null,u=[],b=document.querySelector("#submitInfo").parentNode,f=function(e){var t,n,o;for(e=MP_HELPERS.strToArr(e),o=["",0],n=o[0],t=o[1];t<e.length;)e[t].length<2&&e[t+1].length<2?n+=e[t]:n+=e[t]+" ",t++;return n.trim()},d=function(e,t){var n;return!0===MP_DEBUG&&console.log("checkDashes("+e+", "+t+", "+e.indexOf(" - ")+")"),-1!==e.indexOf(" - ")?(!0===MP_DEBUG&&console.log("> Book title contains a dash"),n=e.split(" - "),n[0]===t?(!0===MP_DEBUG&&console.log("> String before dash is author; using string behind dash"),n[1]):n[0]):e},a=function(e,t){if(!0===MP_DEBUG&&console.log("buildURL("+e+", "+t+")"),"book"===e&&(e="title"),~["title","author","series","on"].indexOf(e))return"series"===e&&(e="on",t+=", #"),"https://www.goodreads.com/search?q="+encodeURIComponent(t).replace("'","&apos;")+"&search_type=books&search%5Bfield%5D="+e},h=function(e,t){return"<a class='mp_button_clone' href='"+t+"' target='_blank'>"+e+"</a> "},m=function(e,t,n){var r,i,s,l,c,p;if(p="",r="","book"===e)r="Title",p=MP_HELPERS.trimStr(MP_HELPERS.bracketRemover(t.textContent),50),p=d(p,o);else if("author"===e){for(r="Author",i=0;i<t.length&&i<3;)p+=t[i].text+" ",i++;p=f(p)}else if("series"===e)for(r="Series",s=0,l=t.length;s<l;s++)c=t[s],p+=c.text+" ";return n=a(e,p),u.splice(0,0,h(r,n)),console.log("> "+e+": "+p+" ("+n+")"),p},b.insertAdjacentHTML("afterend",'<div class="torDetRow"><div class="torDetLeft">Search Goodreads</div><div class="torDetRight mp_grRow"><span class="flex"></span></div></div>'),0!==n.length&&m("series",n,_),0!==e.length&&(o=m("author",e,r)),null!=t&&(i=m("book",t,s)),null!=i&&null!=o&&(l=a("on",i+" "+o),u.splice(0,0,h("Title + Author",l))),p=0,g=u.length;p<g;p++)c=u[p],document.querySelector(".mp_grRow span").innerHTML+=c;return console.log("[M+] Added Goodreads buttons!")},moveBookmark:function(e,t){if(0!==t&&!isNaN(t))return document.querySelector('#mainBody > a[id*="Bookmark"]').setAttribute("class","mp_mark_"+MP_STYLE.theme)},fakeCover:function(e,t){if("missing"===t)return e.innerHTML+='<div class="mp_cover">(no image)</div>',console.log("[M+] Added empty cover!")},simpleDownload:function(e){var t;return"tor"===e?(t=document.querySelector("#dlNormal").href,e="Torrent"):"zip"===e&&(t=document.querySelector("#dlZip").href,e="ZIP"),document.querySelector("#download").innerHTML="<h1><a class='torFormButton mp_formButton' href='"+t+"'>"+e+"</a></h1>",console.log("[M+] Simplified the download link!")},fileList:function(){},initShoutbox:function(){var e,t,n,o,r,i,s;return console.group("Initializing shoutbox..."),s=document.querySelector("#sbf"),r=function(e,t){var n,o,r,i,s;if(!0===MP_DEBUG&&console.log("Running... getShoutParams( "+e+", "+t+" )"),n=[],GM_getValue(e))for(s=GM_getValue(e+"_val").split(","),o=0,r=s.length;o<r;o++)i=s[o],"num"===t?isNaN(Number(i))||n.push(Number(i)):"str"===t&&n.push(i);return n=null!=n[0]&&n,!0===MP_DEBUG&&console.log("Result >",n),n},t=function(e,t){var n;if(!0===MP_DEBUG&&console.log("Running... changeMsg( "+e.id+", "+t+" )"),n={hide:function(){return e.style.filter="blur(3px)",e.style.opacity="0.3"},show:function(){return e.style.filter="blur(0)",e.style.opacity="0.5"},emph:function(){return MP_DEBUG&&console.log(GM_getValue("mp_priority_style_val")),GM_getValue("mp_priority_style_val")?e.style.background="rgba("+GM_getValue("mp_priority_style_val")+")":e.style.background="rgba(125,125,125,0.3)"},alert:function(){return e.style.color="red"}},n[t])return n[t]()},o=function(e,n,o){var r,i,s,l,a;if(!1!==n)for(i=0,s=n.length;i<s;i++)if(l=n[i],a=e.querySelector("a:nth-of-type(2)").href.split("/"),Number(a[a.length-1])===l)if("ignore"===o){t(e,"hide");try{e.addEventListener("mouseenter",function(e){return t(e.target,"show")}),e.addEventListener("mouseleave",function(e){return t(e.target,"hide")})}catch(e){if(r=e,!0!==MP_DEBUG)return;console.warn(r)}}else"priority"===o&&t(e,"emph")},n=function(e,n){var o,r,i,s;if(!1!==n){for(o="",s=e.textContent.split(")"),MP_HELPERS.arrToStr(s.splice(0,1)),s+="",i=0;i<n.length;)o+="\\b"+n[i]+"\\b",i+1!==n.length&&(o+="|"),i++;if(r=new RegExp(o,"i"),s.search(r)>0)return t(e,"alert")}},i=function(e,t){var r,i,s,l;for(l=document.querySelectorAll("#sbf div:not(.mp_processed)"),r=0,i=l.length;r<i;r++)s=l[r],s.classList.contains("mp_processed")||(s.classList.add("mp_processed"),o(s,e.ignore,"ignore"),o(s,e.priority,"priority"),n(s,e.keywords));if(t)return t()},(GM_getValue("mp_block_users")||GM_getValue("mp_priority_users")||GM_getValue("mp_shout_keywords"))&&(!0===MP_DEBUG&&console.log("Shoutbox settings exist"),s&&(!0===MP_DEBUG&&console.log("Page has shoutbox"),e=new Object,e.ignore=r("mp_block_users","num"),e.priority=r("mp_priority_users","num"),e.keywords=r("mp_shout_keywords","str"),MP_HELPERS.pageLoad(function(){return i(e,function(){return window.setInterval(function(){return i(e,!1)},500)})},2340))),console.groupEnd}},MP.run()}catch(e){MP_DEBUG&&console.warn(e)}